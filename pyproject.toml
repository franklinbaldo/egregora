[project]
name = "egregora"
version = "2.0.0"
description = "Ultra-simple pipeline to generate blog posts from WhatsApp exports."
readme = "README.md"
authors = [{ name = "Egregora" }]
requires-python = ">=3.12"
dependencies = [
    "google-genai>=0.3.0",
    "duckdb>=0.10.3",
    "python-frontmatter>=1.0.0",
    "pyyaml>=6.0",
    "ibis-framework[duckdb]>=9.0.0",
    "pandas>=2.0", # Required by ibis.memtable()
    "rich>=13.7.0",
    "diskcache>=5.6.3",
    "python-dateutil>=2.9",
    "pydantic>=2.7",
    "pydantic-ai[logfire]>=0.0.14",
    "repomix>=0.3.4",
    "mdformat>=0.7.22",
    "jinja2>=3.1.0",
    "pyarrow>=21.0.0",
    "typer[all]>=0.20.0",
    "pydantic-settings>=0.1.1",
    "toml>=0.10.2",
    "duckdb-engine>=0.17.0",
    "pytest>=8.4.2",
    "python-slugify>=8.0.1", # Industry-standard slug generation
    "returns>=0.22.0", # Result types for error handling
    "werkzeug>=3.0.0", # Industry-standard path security (safe_join)
    "pydantic-evals[logfire]>=1.0.17",
]

[project.optional-dependencies]
test = [
    "pytest-vcr>=1.0.2",  # HTTP interaction recording for deterministic API tests
    "ruff>=0.4.4",
]
docs = [
    "mkdocs>=1.6",
    "mkdocs-material>=9.5",
    "mkdocstrings[python]>=0.30",
    "mkdocs-autorefs>=1.0",
    "mkdocs-static-i18n>=1.2",
    "python-dateutil>=2.9",
    "pymdown-extensions>=10.0",
    "codespell>=2.3.0",
]
ranking = []
lint = [
    "pre-commit>=3.8",
    "ruff>=0.4.4",
]

[project.scripts]
egregora = "egregora.cli:main"

[build-system]
requires = ["hatchling>=1.21.0"]
build-backend = "hatchling.build"

[tool.hatchling.build.targets.wheel]
packages = ["src/egregora"]

[tool.hatchling.build.targets.wheel.force-include]
"src/egregora/templates" = "egregora/templates"

[tool.uv]
managed = true

[tool.black]
line-length = 100
target-version = ["py312"]

[tool.isort]
profile = "black"

[tool.ruff]
line-length = 110  # Slightly more generous for strings/logs
target-version = "py312"

[tool.ruff.lint]
select = ["E", "F", "I", "UP", "B", "PL", "TID", "RUF", "C4", "PT", "PERF", "FURB"]
ignore = []  # Clean slate!

[tool.ruff.lint.flake8-tidy-imports]
ban-relative-imports = "all"

[tool.ruff.lint.per-file-ignores]
# Source code complexity exceptions
"src/egregora/enrichment/core.py" = ["PLR0913", "PLR0912", "PLR0915", "RUF003"]
"src/egregora/agents/tools/rag/embedder.py" = ["PLR0913"]
"src/egregora/agents/tools/rag/retriever.py" = ["PLR0913"]
"src/egregora/agents/tools/rag/store.py" = ["PLR0912"]
"src/egregora/agents/tools/rag/pydantic_helpers.py" = ["PLR0913"]
"src/egregora/agents/writer/context.py" = ["PLR0911", "PLC0415"]
"src/egregora/enrichment/batch.py" = ["RUF003"]
# CLI and input parsers with intentional patterns
"src/egregora/cli.py" = ["PLR0913", "PLC0415"]
"src/egregora/ingestion/parser.py" = ["RUF001"]
"src/egregora/ingestion/slack_input.py" = ["PLC0415"]
"src/egregora/ingestion/whatsapp_input.py" = ["PLR0911", "PLC0415"]
# Test files with magic values and dynamic imports
"tests/conftest.py" = ["E402"]
"tests/e2e/test_whatsapp_real_scenario.py" = ["PLR0913", "PLR2004", "PLC0208"]
"tests/evals/test_writer_with_evals.py" = ["PLR2004", "PLC0415"]
"tests/evals/writer_evals.py" = ["PLC0415"]
"tests/agents/test_editor_pydantic_agent.py" = ["PLC0415"]
"tests/test_abstraction_layer.py" = ["PLC0415"]
"tests/integration/test_rag_store.py" = ["RUF012"]

[tool.mypy]
python_version = "3.12"
warn_unused_ignores = true
warn_redundant_casts = true
check_untyped_defs = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
disallow_any_generics = false
strict_optional = true

[[tool.mypy.overrides]]
module = [
    "egregora.ingestion.parser",
    "egregora.pipeline",
    "egregora.cli",
]
disallow_untyped_defs = false
disallow_incomplete_defs = false

[[tool.mypy.overrides]]
module = [
    "ibis",
    "ibis.expr",
    "ibis.expr.types",
    "ibis.expr.datatypes",
    "pyarrow",
    "pyarrow.parquet",
    "duckdb",
    "diskcache",
    "frontmatter",
    "google",
    "google.genai",
    "google.genai.types",
    "google.generativeai",
    "google.generativeai.types",
    "google.ai.generativelanguage",
    "jinja2",
    "yaml",
    "dateutil",
    "dateutil.parser",
    "typer",
    "rich",
    "rich.console",
    "rich.progress",
    "rich.logging",
    "rich.markup",
    "rich.panel",
    "pydantic",
    "pydantic.fields",
    "pandas",
    "slugify",
    "returns",
    "returns.result",
    "werkzeug",
    "werkzeug.security",
]
ignore_missing_imports = true

[tool.pytest.ini_options]
pythonpath = ["src"]

[dependency-groups]
dev = [
    "ruff>=0.14.0",
]
test = [
    "pytest>=8.4.2",
    "pytest-vcr>=1.0.2",
    "vcrpy>=6.0.0",
    "ruff>=0.4.4",
    "duckdb>=0.10.0",
]
