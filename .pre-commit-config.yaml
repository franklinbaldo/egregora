exclude: ^(\.team/|artifacts/)
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.7
    hooks:
      - id: ruff
        args: ["--fix", "--unsafe-fixes"]
      - id: ruff-format
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-added-large-files
        args: ["--maxkb=2000"]
      - id: check-ast
      - id: check-case-conflict
      - id: check-merge-conflict
      - id: check-json
      - id: check-toml
      - id: check-yaml
        args: ["--allow-multiple-documents", "--unsafe"]
      - id: debug-statements
      - id: end-of-file-fixer
      - id: mixed-line-ending
      - id: trailing-whitespace
  # Removed custom hooks - now handled by ruff + scripts/quality.sh
  # - check-complexity, check-dead-code, check-security: Use scripts/quality.sh instead
  - repo: local
    hooks:
      # - id: check-root-structure
      #   name: Enforce Clean Root Directory
      #   entry: python scripts/dev_tools/check_root_structure.py
      #   language: system
      #   pass_filenames: false
      #   always_run: true
      - id: vulture
        name: Check for dead code with vulture
        entry: uv run vulture
        args:
          ["src", "tests", "tests/vulture_whitelist.py", "--min-confidence=80"]
        language: system
        types: [python]
        pass_filenames: false
      - id: radon-cc
        name: Check cyclomatic complexity with radon
        entry: uvx radon cc
        args: ["src", "-n", "C", "--total-average"]
        language: system
        types: [python]
        pass_filenames: false
      - id: radon-mi
        name: Check maintainability index with radon
        entry: uvx radon mi
        args: ["src", "-n", "B"]
        language: system
        types: [python]
        pass_filenames: false
      - id: xenon
        name: Enforce complexity thresholds with xenon
        entry: uvx xenon
        args:
          [
            "src",
            "--max-absolute",
            "E",
            "--max-modules",
            "C",
            "--max-average",
            "B",
            "--exclude",
            "*/database/*.py",
          ]
        language: system
        types: [python]
        pass_filenames: false
      - id: bandit
        name: Check security issues with bandit
        entry: uvx bandit
        args:
          ["-r", "src", "-f", "screen", "-c", "pyproject.toml", "-lll", "-ii"]
        language: system
        types: [python]
        pass_filenames: false
      - id: check-private-imports
        name: Check private imports
        entry: scripts/dev_tools/check_private_imports.py
        language: python
        types: [python]
        pass_filenames: true
      - id: check-test-config
        name: Check test configuration
        entry: python scripts/dev_tools/check_test_config.py
        language: system
        pass_filenames: false
        files: tests/.*\.py$
      - id: check-private-imports-antipattern
        name: Check for private function anti-patterns
        entry: python scripts/dev_tools/check_private_imports.py
        language: system
        types: [python]
        files: ^src/
      - id: check-lint-suppressions
        name: "Check for lint suppression comments (noqa, type: ignore)"
        entry: python scripts/dev_tools/check_lint_suppressions.py
        language: system
        types: [python]
        files: ^src/
      - id: unit-tests
        name: Run unit tests
        entry: uv run pytest tests/unit/ -x -q --tb=line --ignore=tests/unit/team
        language: system
        pass_filenames: false
        stages: [pre-push]
      - id: coverage
        name: Check test coverage
        entry: uv run pytest
        args:
          [
            "tests/unit/",
            "--cov=src/egregora",
            "--cov-report=term-missing",
            "--cov-branch",
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
            "--cov-fail-under=60.0",
=======
            "--cov-fail-under=59.6",
>>>>>>> origin/pr/2874
=======
            "--cov-fail-under=59.5",
>>>>>>> origin/pr/2834
=======
            "--cov-fail-under=57",
>>>>>>> origin/pr/2652
            "-q",
            "--ignore=tests/unit/team",
          ]
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-push]
      - id: fix-schedule-csv
        name: Fix schedule.csv format
        entry: uv run python -c "import sys; sys.path.insert(0, '.team'); from repo.scheduler.schedule import load_schedule, validate_and_fix, save_schedule; rows = load_schedule(); fixed, issues = validate_and_fix(rows); save_schedule(fixed) if issues else None; print('Fixed:', len(issues), 'issues') if issues else None"
        language: system
        files: '\.team/schedule\.csv$'
      - id: vote-validation
        name: Validate schedule respects votes
        entry: uv run python -c "import sys; sys.path.insert(0, '.team'); from repo.features.voting import VoteManager; vm = VoteManager(); violations = vm.validate_schedule_vs_votes(); exit(1) if violations else exit(0)"
        language: system
        files: '\.team/(schedule\.csv|votes\.csv)$'
        pass_filenames: false
      - id: prompt-change-validation
        name: Validate persona prompt changes
        entry: uv run python scripts/dev_tools/check_prompt_changes.py
        language: system
        files: '\.team/personas/.*/.*\.j2$'
        pass_filenames: false
      - id: hire-vote-validation
        name: Validate new hires are voted for
        entry: uv run python scripts/dev_tools/check_hire_vote.py
        language: system
        files: '\.team/personas/.*/prompt\.md'
        pass_filenames: false
