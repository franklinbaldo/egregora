# Journal Entry: 2026-01-31-1534
## Goals
- Ensure CLI handles new orchestration exceptions gracefully and refactor exception handling in src/egregora/cli/main.py

## Execution
## ðŸ’£ 2026-01-30 - CLI Error Handling & Pipeline Refactor

**Observation:** The CLI handled errors using ad-hoc `try...except` blocks and `SystemExit` calls, especially in `run_cli_flow` and `validate_api_key`. This violated "Trigger, Don't Confirm" by swallowing context and forcing library code to control process exit.

**Action:**
1.  **Created `src/egregora/cli/errorhandler.py`**: A context manager `handle_cli_errors` that maps domain exceptions (`ApiKeyNotFoundError`, `UnknownAdapterError`, `CommandAnnouncementError`, etc.) to user-friendly, formatted error messages using `rich`.
2.  **Refactored `src/egregora/orchestration/pipelines/write.py`**: Removed the broad `except Exception` block and `exit_on_error` parameter from `run_cli_flow`. It now propagates exceptions.
3.  **Refactored `src/egregora/orchestration/pipelines/etl/setup.py`**: Updated `validate_api_key` to raise `ApiKeyNotFoundError` or `ApiKeyInvalidError` instead of calling `sys.exit(1)`.
4.  **Updated `src/egregora/cli/main.py`**: Wrapped `write`, `init`, `top`, and `show_reader_history` with the error handler. Updated `demo` to remove obsolete `exit_on_error`.
5.  **Verified:** Added `tests/unit/cli/test_errorhandler.py` and ran existing pipeline tests.

**Reflection:** The CLI is now a thin consumer of a robust exception-throwing library. The pipeline logic is cleaner and reusable. Error messages are consistent and informative. The next logical step is to ensure `read` command (reader agent) also uses this pattern.
