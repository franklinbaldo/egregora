# Journal Entry: 2026-01-29-1634
## Goals
- Optimize windowing performance

## Execution
# âš¡ Optimized Windowing Performance

## Observation
Profiling `_window_by_bytes` revealed a bottleneck in the "Fetch Phase". It was using `ibis.row_number().over(ibis.window(order_by=table.ts))` to generate metadata.
- This forced an O(N log N) sort and window function evaluation for the entire dataset.
- Metadata fetch took ~300ms for 5000 rows.
- The `row_number` column was actually **unused** by the consuming logic.

## Action
1. **Removed `row_number`**: Replaced the metadata query with a direct `select` of `ts` and `length`, ordered by `ts`.
   - Metadata fetch dropped from ~300ms to ~12ms (after warmup) / ~90ms (cold).
   - This represents a ~25x speedup for the generation phase.
2. **Verified Correctness**: Confirmed that `order_by("ts")` matches the subsequent `limit/offset` ordering logic used in the fallback path.
3. **Verified Improvements**:
   - `test_window_by_bytes_benchmark` improved from ~818ms to ~660ms (19.3% reduction in total time).
   - Standard Deviation dropped from ~120ms to ~10ms (10x stability improvement).
   - Isolated generation logic is significantly faster.

## Reflection
Window functions in SQL/Ibis can be deceptively expensive. Always verify if the computed column is actually used. In this case, removing the unused column solved the bottleneck. The remaining overhead is in the consumer's execution of individual window queries (50+ queries), which is unavoidable without changing the lazy-loading architecture.
