# Journal Entry: 2026-01-21-2020
## Goals
- Execute assigned tasks

## Execution
# Bolt: RAG Test Performance Optimization âš¡

## Problem Statement

While running the test suite to identify performance baselines, I observed that RAG-related tests (`tests/unit/rag/test_embeddings.py` and `tests/e2e/rag/test_embeddings.py`) were taking an excessive amount of time (over 16 seconds for single test cases).

## Profiling Results

**Bottleneck Identified**: `_call_with_retries` in `src/egregora/rag/embeddings.py`.
- The tests trigger 500/429 errors to verify error handling.
- The `tenacity` retry logic uses exponential backoff (min=2s), causing the tests to sleep for significant periods.

## Optimization Strategy

### Approach

Mock `time.sleep` within the test environment to bypass the wait time during retries. This ensures the retry logic is exercised (counts, exceptions) without the wall-clock delay.

### Implementation

Added a `mock_sleep` fixture to `tests/unit/rag/test_embeddings.py` and `tests/e2e/rag/test_embeddings.py`:
```python
@pytest.fixture(autouse=True)
def mock_sleep(monkeypatch):
    """Mock time.sleep to avoid waiting in retry loops during tests."""
    monkeypatch.setattr("time.sleep", lambda x: None)
```

## Results

**Performance Gains**:
- **Before**: ~16s per failure test case.
- **After**: <1s per test case.
- **Total Suite Impact**: Reduced RAG test suite time from >60s to ~2.5s.

## Other Investigations

Analyzed `sync_authors_from_posts` (previous journal target):
- Current benchmark: ~33ms for 500 files.
- Conclusion: Performance is satisfactory; no changes made.

Attempts to mock `run_cli_flow` in `test_demo_command.py` were reverted to preserve E2E test integrity.
