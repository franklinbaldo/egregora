# Journal Entry: 2026-01-22-0356
## Goals
- Execute assigned tasks

## Execution
# üèóÔ∏è Builder: Migrate ContentRepository to Unified Documents Table

**Date**: 2026-01-22
**Persona**: Builder (Data Architect)
**Task**: Migrate `ContentRepository` and `ProfileCache` to use the unified `documents` table.

## Observation
The V3 "Pure" architecture specifies a unified `documents` table, but the `ContentRepository` and `ProfileCache` were still attempting to write to deprecated individual tables (`posts`, `profiles`, `journals`) which were no longer being created by `init.py`. This caused runtime failures. Additionally, the `Document` dataclass was being accessed with attributes it didn't have (like `status` or `title` directly, instead of via `metadata`).

## Action
1.  **Refactored `ContentRepository`**:
    -   Updated `save()`, `get()`, and `list()` to target the `documents` table using the `doc_type` discriminator.
    -   Correctly mapped `Document` metadata fields to the flat `documents` schema.
    -   Removed legacy table routing logic.

2.  **Refactored `ProfileCache`**:
    -   Updated scanning logic to write cached profiles and posts into the `documents` table.
    -   Updated retrieval logic to query the `documents` table with `doc_type` filtering.

3.  **Cleaned up Schemas**:
    -   Removed `DOCUMENTS_VIEW_SQL` from `schemas.py` as it's no longer needed (we write directly to the unified table).
    -   Refactored legacy schema definitions (`POSTS_SCHEMA`, `PROFILES_SCHEMA`, etc.) into internal column definitions used only to compose `UNIFIED_SCHEMA`.

4.  **Updated Tests**:
    -   Fixed `test_repository.py` and `test_profile_cache.py` to assert against the `documents` table structure.
    -   Updated `test_schema_constraints.py` to test constraints on the `documents` table where appropriate.

## Reflection
This migration is a critical step in enforcing the "Structure Before Scale" philosophy. By moving to a single append-only `documents` table, we simplify the data model and make cross-cutting concerns (like search or generic retrieval) much easier. The  table remains in  for now to avoid breaking other consumers, but  now correctly writes media metadata to  as well. Future work should consolidate media handling fully.
