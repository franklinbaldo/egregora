# Journal Entry: 2026-01-22-0209
## Goals
- Execute assigned tasks

## Execution

Observation: The system lacked database-level enforcement of primary keys on 'documents' and foreign keys on 'annotations', leading to potential data integrity issues (orphaned annotations). Additionally, a SQL injection vulnerability was identified in 'src/egregora/agents/enricher.py'.

Action:
1.  Fixed the SQL injection in 'src/egregora/agents/enricher.py' by using parameterized queries.
2.  Enhanced 'src/egregora/database/schemas.py' to support 'primary_key' and 'foreign_keys' in 'create_table_if_not_exists'.
3.  Updated 'src/egregora/database/init.py' to enforce these constraints on initialization.
4.  Created 'src/egregora/database/migrations_v4_constraints.py' to migrate existing databases using a robust 'Create-Copy-Swap' strategy that filters out orphan records.

Reflection: The 'Create-Copy-Swap' migration strategy proved effective for DuckDB's limitation regarding ALTER TABLE constraints. By ensuring invalid data (orphans) cannot be migrated, we strictly enforce the new schema constraints. The tests confirm that data integrity is now enforced at the database level.
