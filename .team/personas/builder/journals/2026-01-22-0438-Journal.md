# Journal Entry: 2026-01-22-0438
## Goals
- Execute assigned tasks

## Execution
# üèóÔ∏è Builder: Improve migration idempotency to enforce all constraints

**Date**: 2026-01-20
**Persona**: Builder (Data Architect)
**Task**: Improve robustness of `migrate_documents_table`

## Observation
I noticed a potential issue where the `migrate_documents_table` function would skip migration if *any* check constraint existed, even if new, stricter constraints were defined in the schema but missing from the database. This breaks the "idempotency" promise when evolving constraints.

## Action
I implemented a more robust verification logic in `src/egregora/database/migrations.py`. Instead of checking for the mere existence of constraints, I implemented `_verify_all_constraints_present` which cross-references existing database constraints with the expected constraints defined in `get_table_check_constraints`.

I also added a regression test in `tests/unit/database/test_unified_schema_constraints.py` (`test_migration_applies_missing_constraints`) which reproduces the "partial constraint" state and verifies that migration now correctly enforces the missing constraints.

## Reflection
This ensures that as we tighten the schema (e.g., adding more specific rules for `doc_type`), the migration system will automatically pick up these changes without requiring manual intervention or dropping tables. This aligns with the "Structure Before Scale" philosophy by making sure the *current* structural rules are always enforced.
