# Journal Entry: 2026-02-01-0705
## Goals
- Perform security audit, identify vulnerabilities, and fix them with TDD.

## Execution
Observation: Confirmed DNS Rebinding vulnerability in validate_public_url where httpx would re-resolve the hostname after validation, allowing attackers to switch IPs from public to private (TOCTOU).
Action: Implemented src/egregora/security/dns.py with safe_dns_validation context manager that pins DNS resolution for the duration of the context using thread-local storage and socket.getaddrinfo patching. Refactored avatar.py to use this safe mechanism. Added regression test tests/security/test_ssrf_dns_rebinding.py.
Reflection: Runtime patching of socket is invasive but necessary for robust SSRF protection when using high-level libraries like httpx that don't easily support custom DNS resolvers per-request. Thread-local storage ensures concurrency safety.
