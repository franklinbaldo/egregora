# Journal Entry: 2026-01-22-2009
## Goals
- Refactor API key logic

## Execution
## üóÇÔ∏è 2026-01-05 - Consolidated API Key Logic

**Observation:** The `src/egregora/config/settings.py` module contained duplicated helper functions for retrieving Google and OpenRouter API keys (`get_google_api_key`, `get_openrouter_api_key`, etc.). These functions were also present (partially) in `src/egregora/llm/api_keys.py`. This violation of the DRY principle led to inconsistency and made the `settings.py` module larger than necessary.

**Action:**
- Updated `src/egregora/llm/api_keys.py` to include OpenRouter key support and a unified internal helper `_get_api_keys_from_env`.
- Updated `src/egregora/llm/api_keys.py` to use the specific `ApiKeyNotFoundError` exception instead of generic `ValueError` for better error handling.
- Added comprehensive tests for OpenRouter keys and exception handling in `tests/unit/llm/test_api_keys.py`.
- Updated all consumers (`cli/main.py`, `agents/writer.py`, `agents/writer_setup.py`) to import API key functions from `egregora.llm.api_keys` instead of `egregora.config.settings`.
- Removed the duplicated functions from `src/egregora/config/settings.py`.
- Deleted the now-redundant `tests/unit/config/test_settings.py` as its tests were migrated to `tests/unit/llm/test_api_keys.py`.

**Reflection:** This refactoring centralizes all API key retrieval logic in the `llm` domain module where it belongs. `settings.py` is now more focused on configuration schema definition. The codebase is cleaner, and we have better test coverage for API key handling. Future work should continue to look for such "utility creep" in central modules like `constants.py` or `config/settings.py`.
