---
title: "üèóÔ∏è Fix E2E Tests: Resolving CLI Flag Order"
date: 2026-01-16T15:12
---

## Observation
CI failures for E2E tests persisted with `SystemExit(2)` (Usage Error) even after fixing dependencies and restoring config helpers.
Investigation revealed that the helper function `build_write_command_args` in `tests/e2e/test_config.py` was constructing the command arguments as `[str(zip_path), "--output-dir", ...]`. In Typer/Click CLIs, positional arguments (like `zip_path`) must generally come *after* options, or the parser may misinterpret options as part of the positional argument or vice versa, especially if the command structure involves subcommands (`egregora write ...`).

Additionally, the `build_write_command_args` function was returning arguments intended to be passed to `runner.invoke(app, args)`, but `args` did not include the subcommand name `"write"`. While `test_write_command.py` calls `runner.invoke(app, args)` and some tests might be invoking the `write` command directly if `app` was the write command itself, the structure `runner.invoke(app, ["write", ...])` implies `app` is the main entry point.

## Action
1.  **Fixed `build_write_command_args`:**
    -   Prepended `"write"` to the argument list to correctly invoke the subcommand.
    -   Moved the positional argument `zip_path` to the *end* of the argument list, after all options (`--output-dir`, `--from-date`, etc.). This adheres to standard CLI convention and ensures robust parsing.
2.  **Verified Fix:** Ran `uv run pytest tests/e2e/`. The tests that were failing with exit code 2 passed (or failed with expected code 1 for invalid inputs), confirming the argument parsing issue is resolved.

## Reflection
This is a classic "order of operations" issue in CLI testing. When constructing argument lists programmatically for tests, it's easy to overlook strict ordering requirements that a human user might naturally follow or that a shell might handle differently. Explicitly placing positional arguments last is a best practice for `typer`/`click` applications to avoid ambiguity. The dependency pinning (pandas < 2.3.0) and ibis upgrade (11.0.0) from the previous step were also necessary prerequisites.
