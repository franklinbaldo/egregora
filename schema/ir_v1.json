{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "IR v1 Schema (Ibis Format)",
  "description": "Intermediate Representation v1 for Egregora pipeline. This is the canonical schema that all source adapters must output.",
  "version": "1.0.0",
  "locked": true,
  "fields": {
    "event_id": {
      "type": "uuid",
      "nullable": false,
      "description": "Primary key, deterministic UUID5 generated from source + msg_id"
    },
    "tenant_id": {
      "type": "string",
      "nullable": false,
      "default": "default",
      "description": "Tenant identifier for multi-tenant isolation"
    },
    "source": {
      "type": "string",
      "nullable": false,
      "pattern": "^[a-z]+$",
      "enum": ["whatsapp", "slack", "discord", "telegram"],
      "description": "Source platform identifier (lowercase)"
    },
    "thread_id": {
      "type": "uuid",
      "nullable": false,
      "description": "Thread/conversation identifier (UUID5)"
    },
    "msg_id": {
      "type": "string",
      "nullable": false,
      "description": "Source-specific message identifier"
    },
    "ts": {
      "type": "timestamp",
      "timezone": "UTC",
      "nullable": false,
      "description": "Message timestamp in UTC"
    },
    "author_raw": {
      "type": "string",
      "nullable": false,
      "privacy": "sensitive",
      "description": "Original author name (NEVER send to LLM)"
    },
    "author_uuid": {
      "type": "uuid",
      "nullable": false,
      "description": "Anonymized author identifier (UUID5)"
    },
    "text": {
      "type": "string",
      "nullable": true,
      "description": "Message text content"
    },
    "media_url": {
      "type": "string",
      "nullable": true,
      "description": "URL or path to media attachment"
    },
    "media_type": {
      "type": "string",
      "nullable": true,
      "description": "Media MIME type or category"
    },
    "attrs": {
      "type": "json",
      "nullable": true,
      "description": "Source-specific metadata (flexible schema)"
    },
    "pii_flags": {
      "type": "json",
      "nullable": true,
      "description": "PII detection results from privacy gate"
    },
    "created_at": {
      "type": "timestamp",
      "timezone": "UTC",
      "nullable": false,
      "default": "now()",
      "description": "Row creation timestamp (ingestion time)"
    },
    "created_by_run": {
      "type": "uuid",
      "nullable": true,
      "description": "Foreign key to runs.run_id"
    }
  },
  "primary_key": ["event_id"],
  "unique_constraints": [
    ["tenant_id", "source", "thread_id", "msg_id"]
  ],
  "indexes": [
    {
      "name": "idx_ir_v1_thread_ts",
      "columns": ["thread_id", "ts"],
      "type": "btree"
    },
    {
      "name": "idx_ir_v1_tenant",
      "columns": ["tenant_id", "source"],
      "type": "btree"
    },
    {
      "name": "idx_ir_v1_author",
      "columns": ["author_uuid"],
      "type": "btree"
    },
    {
      "name": "idx_ir_v1_run",
      "columns": ["created_by_run"],
      "type": "btree",
      "where": "created_by_run IS NOT NULL"
    }
  ],
  "ibis_schema": {
    "event_id": "uuid",
    "tenant_id": "string",
    "source": "string",
    "thread_id": "uuid",
    "msg_id": "string",
    "ts": "timestamp(timezone='UTC')",
    "author_raw": "string",
    "author_uuid": "uuid",
    "text": "!string",
    "media_url": "!string",
    "media_type": "!string",
    "attrs": "!json",
    "pii_flags": "!json",
    "created_at": "timestamp(timezone='UTC')",
    "created_by_run": "!uuid"
  },
  "notes": {
    "nullable_syntax": "Fields prefixed with ! in ibis_schema are nullable",
    "migration_path": "See ir_v1.sql for CONVERSATION_SCHEMA â†’ IR v1 mapping",
    "breaking_changes": "Requires new version (ir_v2.sql) and migration script"
  }
}
