name: Auto-merge dependency and bot updates

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Enable auto-merge for dependency and bot PRs
    runs-on: ubuntu-latest
    # Run for dependabot, renovate, or Jules bot PRs
    if: |
      github.actor == 'dependabot[bot]' ||
      github.actor == 'renovate[bot]' ||
      github.actor == 'google-labs-jules[bot]'

    steps:
      # SECURITY: Validate that PR only modifies dependency files for dependency bots
      # Skip validation for Jules bot (creates code PRs, not dependency PRs)
      - name: Validate PR changes
        if: github.actor == 'dependabot[bot]' || github.actor == 'renovate[bot]'
        uses: actions/github-script@v8
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // Only allow changes to dependency files for dependabot/renovate
            const allowedPatterns = [
              /^package\.json$/,
              /^package-lock\.json$/,
              /^pyproject\.toml$/,
              /^uv\.lock$/,
              /^requirements.*\.txt$/,
              /^\.github\/workflows\/.*\.yml$/  // Allow workflow updates from bots
            ];

            const unauthorizedFiles = files.filter(file =>
              !allowedPatterns.some(pattern => pattern.test(file.filename))
            );

            if (unauthorizedFiles.length > 0) {
              const fileList = unauthorizedFiles.map(f => f.filename).join(', ');
              core.setFailed(`PR contains unauthorized file changes: ${fileList}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è **Auto-merge blocked**: This PR modifies files outside of dependency files.\n\nUnauthorized files: ${fileList}\n\nPlease review manually.`
              });
            } else {
              console.log('‚úÖ All file changes are in allowed dependency files');
            }

      - name: Convert draft to ready for review
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const isDraft = context.payload.pull_request.draft;

            if (isDraft) {
              console.log('üìù PR is a draft, converting to ready for review...');

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number,
                draft: false
              });

              console.log('‚úÖ PR converted to ready for review');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: 'ü§ñ **Draft converted to ready for review**\n\nThis PR has been automatically marked as ready for review and will be auto-merged when CI passes.'
              });
            } else {
              console.log('‚úÖ PR is already ready for review');
            }

      - name: Get PR metadata
        id: metadata
        if: github.actor == 'dependabot[bot]'
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const actor = context.actor;

            let approvalMessage = '‚úÖ Auto-approved by CI workflow';
            if (actor === 'google-labs-jules[bot]') {
              approvalMessage = '‚úÖ Auto-approved by CI workflow - Jules bot update';
            } else {
              approvalMessage = '‚úÖ Auto-approved by CI workflow - dependency update';
            }

            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              event: 'APPROVE',
              body: approvalMessage
            });

            console.log('‚úÖ PR approved');

      - name: Enable auto-merge
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const actor = context.actor;
            const updateType = '${{ steps.metadata.outputs.update-type }}';

            console.log(`Actor: ${actor}`);
            console.log(`Update type: ${updateType}`);

            // Auto-merge conditions:
            // 1. It's Jules bot
            // 2. It's a minor/patch dependency update
            const shouldAutoMerge = (actor === 'google-labs-jules[bot]') ||
                                    (updateType === 'version-update:semver-patch' ||
                                     updateType === 'version-update:semver-minor');

            if (shouldAutoMerge) {
              try {
                // Enable GitHub's native auto-merge feature
                await github.graphql(`
                  mutation($pullRequestId: ID!) {
                    enablePullRequestAutoMerge(input: {
                      pullRequestId: $pullRequestId,
                      mergeMethod: SQUASH
                    }) {
                      pullRequest {
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }
                `, {
                  pullRequestId: context.payload.pull_request.node_id
                });

                console.log('‚úÖ Auto-merge enabled - PR will merge when all checks pass');

                let mergeReason = '';
                if (actor === 'google-labs-jules[bot]') {
                  mergeReason = 'Jules bot update';
                } else {
                  mergeReason = `dependency update (${updateType})`;
                }

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pull_number,
                  body: `ü§ñ **Auto-merge enabled**\n\nThis PR will automatically merge when all required checks pass.\n\n_Reason: ${mergeReason}_`
                });

              } catch (error) {
                console.log(`‚ö†Ô∏è Could not enable auto-merge: ${error.message}`);
                console.log('Note: Auto-merge requires branch protection rules to be enabled');
              }
            } else {
              console.log(`‚è≠Ô∏è Skipping auto-merge - conditions not met`);

              if (actor !== 'google-labs-jules[bot]') {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pull_number,
                  body: `‚ÑπÔ∏è **Manual review required**\n\nThis is a ${updateType} update, which requires manual approval before merging.`
                });
              }
            }