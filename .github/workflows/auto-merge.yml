name: Auto-merge dependency updates

on:
  pull_request:  # Changed from pull_request_target for security
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Enable auto-merge for dependency PRs
    runs-on: ubuntu-latest
    # Only run for dependabot or renovate PRs
    if: |
      github.actor == 'dependabot[bot]' ||
      github.actor == 'renovate[bot]'

    steps:
      # SECURITY: Validate that PR only modifies dependency files
      - name: Validate PR changes
        uses: actions/github-script@v8
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // Only allow changes to dependency files
            const allowedPatterns = [
              /^package\.json$/,
              /^package-lock\.json$/,
              /^pyproject\.toml$/,
              /^uv\.lock$/,
              /^requirements.*\.txt$/,
              /^\.github\/workflows\/.*\.yml$/  // Allow workflow updates from bots
            ];

            const unauthorizedFiles = files.filter(file =>
              !allowedPatterns.some(pattern => pattern.test(file.filename))
            );

            if (unauthorizedFiles.length > 0) {
              const fileList = unauthorizedFiles.map(f => f.filename).join(', ');
              core.setFailed(`PR contains unauthorized file changes: ${fileList}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è **Auto-merge blocked**: This PR modifies files outside of dependency files.\n\nUnauthorized files: ${fileList}\n\nPlease review manually.`
              });
            } else {
              console.log('‚úÖ All file changes are in allowed dependency files');
            }


      - name: Get PR metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              event: 'APPROVE',
              body: '‚úÖ Auto-approved by CI workflow - dependency update'
            });

            console.log('‚úÖ PR approved');

      - name: Enable auto-merge
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const updateType = '${{ steps.metadata.outputs.update-type }}';

            console.log(`Update type: ${updateType}`);

            // Only auto-merge minor/patch updates
            if (updateType === 'version-update:semver-patch' ||
                updateType === 'version-update:semver-minor') {

              try {
                // Enable GitHub's native auto-merge feature
                await github.graphql(`
                  mutation($pullRequestId: ID!) {
                    enablePullRequestAutoMerge(input: {
                      pullRequestId: $pullRequestId,
                      mergeMethod: SQUASH
                    }) {
                      pullRequest {
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }
                `, {
                  pullRequestId: context.payload.pull_request.node_id
                });

                console.log('‚úÖ Auto-merge enabled - PR will merge when all checks pass');

                // Post a comment explaining what will happen
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pull_number,
                  body: 'ü§ñ **Auto-merge enabled**\n\nThis PR will automatically merge when all required checks pass.\n\n_Update type: `' + updateType + '`_'
                });

              } catch (error) {
                console.log(`‚ö†Ô∏è Could not enable auto-merge: ${error.message}`);
                console.log('Note: Auto-merge requires branch protection rules to be enabled');
              }
            } else {
              console.log(`‚è≠Ô∏è Skipping auto-merge - update type is ${updateType}`);
              console.log('Only auto-merging patch and minor updates');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `‚ÑπÔ∏è **Manual review required**\n\nThis is a \`${updateType}\` update, which requires manual approval before merging.`
              });
            }
