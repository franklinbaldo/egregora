name: Detect Code Regressions

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '.team/repo/**'
      - 'src/**'

jobs:
  detect-regression:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for regression detection

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Run regression detector
        id: check
        continue-on-error: true
        run: |
          python .github/scripts/detect_regression.py \
            --lookback-days 30 \
            --non-interactive

      - name: Comment on PR if regression detected
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const issue_number = context.issue.number;

            // Get the output from the previous step
            const output = `⚠️ **Potential Code Regression Detected**

            This PR appears to revert recent code changes back to earlier states.

            **What does this mean?**
            - One or more files in this PR match their content from a recent commit
            - This could be an accidental reversion of recent work
            - Or it could be an intentional revert (which is fine!)

            **What to do:**
            1. Review the files flagged in the check logs above
            2. Verify if this is intentional
            3. If accidental, check what changes were lost and restore them
            4. If intentional, document why in the PR description

            **How to check:**
            Run locally:
            \`\`\`bash
            python .github/scripts/detect_regression.py
            \`\`\`

            This will show which files match earlier commits and give you details.

            ---
            *This check helps prevent accidental loss of recent work. It's a warning, not a blocker.*
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: output
            });

      - name: Add regression label
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['⚠️ possible-regression']
            });

      - name: Fail if regression detected
        if: steps.check.outcome == 'failure'
        run: |
          echo "❌ Regression detected. Please review before merging."
          exit 1
