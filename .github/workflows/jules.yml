name: Jules

# ==============================================================================
# JULES UNIFIED WORKFLOW
# ==============================================================================
#
# This workflow manages the complete Jules AI agent lifecycle:
# - Session orchestration (scheduler)
# - PR automation (auto-merge, auto-fix)
# - Branch synchronization
#
# COMPLETE FLOW:
# ==============
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                                                                         â”‚
#   â”‚   1. SCHEDULER runs (via cron, manual, or on-merge trigger)             â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   2. Scheduler picks next persona from schedule.csv                     â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   3. Creates Jules session via API with persona's prompt                â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   4. Jules works asynchronously, creates PR when done                   â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   5. AUTO-MERGE enables auto-merge on the PR                            â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   6. CI runs on the PR                                                  â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   7a. If CI passes â†’ PR is auto-merged â†’ ON-MERGE triggers scheduler    â”‚
#   â”‚   7b. If CI fails â†’ AUTO-FIXER analyzes and sends fix to Jules          â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   8. Cycle repeats                                                      â”‚
#   â”‚                                                                         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# JOBS:
# =====
#
#   on-merge:    Detects Jules PR merge â†’ triggers scheduler
#   scheduler:   Picks persona, creates Jules session
#   sync-main:   Merges jules branch into main
#   auto-merge:  Enables auto-merge for Jules PRs
#   auto-fixer:  Analyzes CI failures, triggers fixes
#
# STATE MANAGEMENT:
# =================
#
#   Schedule state is stored as a GitHub Artifact (not committed).
#   This prevents merge conflicts from concurrent runs.
#
# SECURITY NOTES:
# ===============
#
#   - auto-merge uses pull_request_target (has write access to base repo)
#   - MUST verify PR is from same repo (not a fork) before running
#   - Fork PRs are silently skipped to prevent secret exposure
#
# ==============================================================================

on:
  # Scheduler triggers
  workflow_dispatch:
    inputs:
      prompt_id:
        description: "Run only a specific prompt id (e.g. curator)"
        required: false
        type: string
      run_all:
        description: "Ignore schedules and run all enabled prompts"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Do not call Jules API (prints what would run)"
        required: false
        type: boolean
        default: false
      reset:
        description: "Reset the persona cycle and start from the first persona"
        required: false
        type: boolean
        default: false
      pr_number:
        description: "PR number to analyze and fix (auto-fixer)"
        required: false
        type: string

  schedule:
    # Fallback polling - primary trigger is on-merge event
    - cron: '*/15 * * * *'

  # On-merge trigger
  pull_request:
    types: [closed]
    branches: [main, jules]

  # Auto-merge trigger (SECURITY: has write access even on forks)
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

  # Sync-main trigger
  push:
    branches: [jules]

  # Chain from CI completion (success â†’ scheduler, failure â†’ auto-fixer)
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: jules-${{ github.event_name }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ==========================================================================
  # ON-MERGE: Trigger scheduler when Jules PR is merged
  # ==========================================================================
  on-merge:
    name: On-Merge Trigger
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      (github.event.pull_request.user.login == 'google-labs-jules[bot]' ||
       github.event.pull_request.user.login == 'google-labs-jules')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger scheduler for next session
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Jules PR #${{ github.event.pull_request.number }} merged"
          echo "ðŸš€ Triggering scheduler for next session..."
          gh workflow run jules.yml --repo "${{ github.repository }}" --ref main

  # ==========================================================================
  # SCHEDULER: Main orchestration
  # ==========================================================================
  scheduler:
    name: Scheduler
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number == '') ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       (startsWith(github.event.workflow_run.head_branch, 'jules-sched-') ||
        github.event.workflow_run.head_branch == 'main' ||
        github.event.workflow_run.head_branch == 'jules'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      # Sparse checkout for faster clone - only what scheduler needs
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/actions
            .github/scripts/jules
            .team
            src
            pyproject.toml
            uv.lock

      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      # Restore schedule state from artifact
      - name: Download schedule state
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          name: schedule-state
          workflow: jules.yml
          workflow_conclusion: success
          if_no_artifact_found: warn

      - name: Restore schedule state
        run: .github/scripts/jules/restore-schedule-state.sh

      - name: Run scheduler
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: .team
        run: |
          args=()
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            [ "${{ inputs.run_all }}" = "true" ] && args+=(--all)
            [ "${{ inputs.dry_run }}" = "true" ] && args+=(--dry-run)
            [ "${{ inputs.reset }}" = "true" ] && args+=(--reset)
            [ -n "${{ inputs.prompt_id }}" ] && args+=(--prompt-id "${{ inputs.prompt_id }}")
          fi
          .github/scripts/jules/run-scheduler.sh "${args[@]}"

      # Save schedule state as artifact
      - name: Upload schedule state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schedule-state
          path: |
            .team/schedule.csv
            .team/oracle_schedule.csv
          retention-days: 90
          overwrite: true

  # ==========================================================================
  # SYNC-MAIN: Merge jules branch into main
  # ==========================================================================
  sync-main:
    name: Sync â†’ Main
    needs: [scheduler]
    if: |
      always() &&
      (needs.scheduler.result == 'success' || needs.scheduler.result == 'skipped') &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number == '') ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Sync jules â†’ main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: .team
        run: uv run python .github/scripts/jules/sync-main.py

  # ==========================================================================
  # AUTO-MERGE: Enable auto-merge for Jules PRs
  # ==========================================================================
  auto-merge:
    name: Auto-Merge
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    # Security: only run for PRs from same repo (not forks)
    concurrency:
      group: jules-auto-merge-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Checkout scripts
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts/jules

      - name: Enable auto-merge
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/jules/enable-auto-merge.sh "${{ github.event.pull_request.number }}"

  # ==========================================================================
  # AUTO-FIXER: Fix CI failures automatically
  # ==========================================================================
  auto-fixer:
    name: Auto-Fixer
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != '') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Identify PR (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: manual-pr
        run: |
          echo "has_pr=true" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT

      - name: Identify PR (workflow_run)
        if: github.event_name == 'workflow_run'
        id: workflow-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/jules/identify-pr.sh "$GITHUB_EVENT_PATH"

      - name: Run auto-fix
        if: |
          steps.manual-pr.outputs.has_pr == 'true' ||
          steps.workflow-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          PYTHONPATH: .team
        run: |
          PR_NUMBER="${{ steps.manual-pr.outputs.pr_number || steps.workflow-pr.outputs.pr_number }}"
          echo "ðŸ”§ Running auto-fix for PR #$PR_NUMBER"
          uv run python -m repo.cli autofix analyze "$PR_NUMBER"
