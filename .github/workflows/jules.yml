name: Jules

# ==============================================================================
# JULES UNIFIED WORKFLOW
# ==============================================================================
#
# This workflow manages the complete Jules AI agent lifecycle:
# - Session orchestration (scheduler)
# - PR automation (auto-merge, auto-fix)
# - Branch synchronization
#
# COMPLETE FLOW (Ralph Wiggum Style):
# ===================================
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                                                                         â”‚
#   â”‚   1. SCHEDULER runs (via cron, manual, or on-merge trigger)             â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   2. Query Jules API for last persona (stateless - no CSV)              â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   3. Calculate next persona (round-robin)                               â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   4. Create Jules session via API                                       â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   5. Jules works asynchronously, creates PR when done                   â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   6. AUTO-MERGE enables auto-merge on the PR                            â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   7. CI runs on the PR                                                  â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   7a. If CI passes â†’ PR auto-merges â†’ ON-MERGE triggers scheduler       â”‚
#   â”‚   7b. If CI fails â†’ AUTO-FIXER analyzes and sends fix to Jules          â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   8. Cycle repeats (stateless iteration)                                â”‚
#   â”‚                                                                         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# JOBS:
# =====
#
#   on-merge:    Detects Jules PR merge â†’ triggers scheduler
#   scheduler:   Queries API, picks next persona, creates session
#   sync-main:   Merges jules branch into main
#   auto-merge:  Enables auto-merge for Jules PRs
#   auto-fixer:  Analyzes CI failures, triggers fixes
#
# STATE MANAGEMENT:
# =================
#
#   Jules API is the source of truth. Each tick:
#   - Queries API for active sessions (skip if running)
#   - Queries API for last persona
#   - Calculates next persona (round-robin)
#   - Creates new session
#
#   No CSV, no artifacts, no external state. Fully stateless.
#
# SECURITY NOTES:
# ===============
#
#   - auto-merge uses pull_request_target (has write access to base repo)
#   - MUST verify PR is from same repo (not a fork) before running
#   - Fork PRs are silently skipped to prevent secret exposure
#
# ==============================================================================

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Do not call Jules API (prints what would run)"
        required: false
        type: boolean
        default: false
      pr_number:
        description: "PR number to analyze and fix (auto-fixer mode)"
        required: false
        type: string

  schedule:
    # Fallback polling - primary trigger is on-merge event
    - cron: '*/15 * * * *'

  # On-merge trigger
  pull_request:
    types: [closed]
    branches: [main, jules]

  # Auto-merge trigger (SECURITY: has write access even on forks)
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

  # Sync-main trigger
  push:
    branches: [jules]

  # Chain from CI completion (success â†’ scheduler, failure â†’ auto-fixer)
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: jules-${{ github.event_name }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ==========================================================================
  # ON-MERGE: Trigger scheduler when Jules PR is merged
  # ==========================================================================
  on-merge:
    name: On-Merge Trigger
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      (github.event.pull_request.user.login == 'google-labs-jules[bot]' ||
       github.event.pull_request.user.login == 'google-labs-jules' ||
       github.event.pull_request.user.login == github.repository_owner)
    runs-on: ubuntu-latest
    steps:
      - name: Check for Jules URL in PR body
        id: check-jules
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # Check if PR body contains Jules URL
          if echo "$PR_BODY" | grep -qE 'jules\.google\.com/(task|session)'; then
            echo "is_jules=true" >> $GITHUB_OUTPUT
            echo "âœ… Found Jules URL in PR body"
          elif [[ "$PR_AUTHOR" == "google-labs-jules"* ]]; then
            echo "is_jules=true" >> $GITHUB_OUTPUT
            echo "âœ… PR created by Jules bot"
          else
            echo "is_jules=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Not a Jules PR, skipping scheduler trigger"
          fi

      - name: Trigger scheduler for next session
        if: steps.check-jules.outputs.is_jules == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Jules PR #${{ github.event.pull_request.number }} merged"
          echo "ðŸš€ Triggering scheduler for next session..."
          gh workflow run jules.yml --repo "${{ github.repository }}" --ref main

  # ==========================================================================
  # SCHEDULER: Main orchestration (stateless - queries Jules API)
  # ==========================================================================
  scheduler:
    name: Scheduler
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number == '') ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check if Jules PR (workflow_run)
        if: github.event_name == 'workflow_run'
        id: check-jules-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          BRANCH="$HEAD_BRANCH"
          echo "Branch: $BRANCH"

          # Always allow main and jules branches
          if [[ "$BRANCH" == "main" || "$BRANCH" == "jules" || "$BRANCH" == jules-sched-* ]]; then
            echo "is_jules=true" >> $GITHUB_OUTPUT
            echo "âœ… Core branch ($BRANCH) - running scheduler"
            exit 0
          fi

          # For other branches, check if there's a PR with Jules URL
          PR_JSON=$(gh pr list --head "$BRANCH" --json number,body --limit 1 --repo "${{ github.repository }}" 2>/dev/null || echo "[]")

          if [ "$PR_JSON" == "[]" ] || [ -z "$PR_JSON" ]; then
            echo "is_jules=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No PR found for branch $BRANCH"
            exit 0
          fi

          PR_BODY=$(echo "$PR_JSON" | jq -r '.[0].body // ""')

          if echo "$PR_BODY" | grep -qE 'jules\.google\.com/(task|session)'; then
            echo "is_jules=true" >> $GITHUB_OUTPUT
            echo "âœ… Found Jules URL in PR body - running scheduler"
          else
            echo "is_jules=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Jules URL in PR body - skipping scheduler"
          fi
      - uses: actions/checkout@v6
        if: github.event_name != 'workflow_run' || steps.check-jules-pr.outputs.is_jules == 'true'
        with:
          sparse-checkout: |
            .github/actions
            .team
            src
            pyproject.toml
            uv.lock

      - uses: ./.github/actions/setup-python-uv
        if: github.event_name != 'workflow_run' || steps.check-jules-pr.outputs.is_jules == 'true'
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Run scheduler
        if: github.event_name != 'workflow_run' || steps.check-jules-pr.outputs.is_jules == 'true'
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: .team
        run: |
          args=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            args="--dry-run"
          fi
          uv run python -m repo.cli schedule tick $args

  # ==========================================================================
  # SYNC-MAIN: Merge jules branch into main
  # ==========================================================================
  sync-main:
    name: Sync â†’ Main
    needs: [scheduler]
    if: |
      always() &&
      (needs.scheduler.result == 'success' || needs.scheduler.result == 'skipped') &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number == '') ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Sync jules â†’ main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: .team
        run: uv run python .github/scripts/jules/sync-main.py

  # ==========================================================================
  # AUTO-MERGE: Enable auto-merge for Jules PRs
  # ==========================================================================
  auto-merge:
    name: Auto-Merge
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    concurrency:
      group: jules-auto-merge-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Checkout scripts
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: .github/scripts/jules

      - name: Enable auto-merge
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/jules/enable-auto-merge.sh "${{ github.event.pull_request.number }}"

  # ==========================================================================
  # AUTO-FIXER: Fix CI failures automatically
  # ==========================================================================
  auto-fixer:
    name: Auto-Fixer
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != '') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Identify PR (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: manual-pr
        env:
          PR_NUMBER_INPUT: ${{ github.event.inputs.pr_number }}
        run: |
          echo "has_pr=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER_INPUT" >> $GITHUB_OUTPUT

      - name: Identify PR (workflow_run)
        if: github.event_name == 'workflow_run'
        id: workflow-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/jules/identify-pr.sh "$GITHUB_EVENT_PATH"

      - name: Run auto-fix
        if: |
          steps.manual-pr.outputs.has_pr == 'true' ||
          steps.workflow-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          PYTHONPATH: .team
        run: |
          PR_NUMBER="${{ steps.manual-pr.outputs.pr_number || steps.workflow-pr.outputs.pr_number }}"
          echo "ðŸ”§ Running auto-fix for PR #$PR_NUMBER"
          uv run python -m repo.cli autofix analyze "$PR_NUMBER"
