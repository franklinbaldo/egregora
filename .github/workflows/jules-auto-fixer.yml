name: Jules Auto-Fixer

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string

permissions:
  pull-requests: read
  contents: read

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    # Run if CI failed OR if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Identify PR
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "is_jules=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          EVENT_FILE="${GITHUB_EVENT_PATH}"
          # Try to get PR URL directly from the event
          PR_URL=$(jq -r '.workflow_run.pull_requests[0].url // empty' "$EVENT_FILE")

          # If not present, try to find a PR by matching head SHA
          if [[ -z "$PR_URL" ]]; then
            HEAD_SHA=$(jq -r '.workflow_run.head_sha // empty' "$EVENT_FILE")
            if [[ -n "$HEAD_SHA" ]]; then
              # List all PRs (state=all) and look for one whose head.sha matches the run head SHA
              PR_URL=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=all" \
                | jq -r --arg sha "$HEAD_SHA" '.[] | select(.head.sha == $sha) | .url' | head -n1)
            fi
          fi

          if [[ -z "$PR_URL" ]]; then
            echo "No pull request associated with this workflow_run; skipping Jules auto-fix."
            echo "is_jules=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_JSON=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "$PR_URL")
          PR_USER=$(echo "$PR_JSON" | jq -r '.user.login // empty')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')

          if [[ -z "$PR_NUMBER" ]]; then
            echo "Failed to determine PR number from $PR_URL"
            echo "is_jules=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$PR_USER" == "google-labs-jules[bot]" ]]; then
            echo "is_jules=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "is_jules=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Jules Auto-Fix
        if: steps.pr-info.outputs.is_jules == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          JULES_BASE_URL: https://jules.googleapis.com/v1alpha
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          # Get PR details
          PR_JSON=$(gh pr view "$PR_NUMBER" --json number,title,headRefName,baseRefName,body,files,comments)
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
          BASE_BRANCH=$(echo "$PR_JSON" | jq -r '.baseRefName')
          PR_BODY=$(echo "$PR_JSON" | jq -r '.body // ""')

          # Get session ID from PR comments
          SESSION_ID=$(echo "$PR_JSON" | jq -r '.comments[] | select(.body | contains("Jules Session:")) | .body' | grep -oP 'sessions/[a-f0-9-]+' | head -n1 || echo "")

          # Check CI status
          CI_CHECKS=$(gh pr checks "$PR_NUMBER" --json name,state,conclusion || echo "[]")
          FAILED_CHECKS=$(echo "$CI_CHECKS" | jq -r '[.[] | select(.conclusion == "failure" or .state == "FAILURE")] | .[].name' | paste -sd, -)

          # Check for merge conflicts
          HAS_CONFLICTS=$(gh pr view "$PR_NUMBER" --json mergeable | jq -r 'if .mergeable == "CONFLICTING" then "true" else "false" end')

          # If PR is healthy, exit
          if [[ -z "$FAILED_CHECKS" && "$HAS_CONFLICTS" == "false" ]]; then
            echo "PR is healthy, no action needed"
            exit 0
          fi

          # Construct feedback message
          FEEDBACK="Issues detected in Pull Request #${PR_NUMBER}:\n"
          if [[ "$HAS_CONFLICTS" == "true" ]]; then
            FEEDBACK="${FEEDBACK}- **Merge Conflicts** detected. Please rebase and resolve them.\n"
          fi
          if [[ -n "$FAILED_CHECKS" ]]; then
            FEEDBACK="${FEEDBACK}- **CI Failures**: ${FAILED_CHECKS}\n"
          fi

          AUTONOMOUS_INSTRUCTION="\n\n**ðŸ¤– CRITICAL - Full Autonomy Required:**\n- **NEVER ask humans for help, approval, or implementation decisions**\n- **ALWAYS make your own technical decisions** using your senior developer expertise\n- **If tests fail:** Debug, fix the issue, adjust your approach - don't ask for help\n- **You are a senior developer:** Trust your experience - ship working code confidently\n"

          # Try to message existing session
          if [[ -n "$SESSION_ID" ]]; then
            MESSAGE="Hi Jules! Please fix these issues in PR #${PR_NUMBER}:\n\n${FEEDBACK}${AUTONOMOUS_INSTRUCTION}"

            curl -sf -X POST \
              "${JULES_BASE_URL}/sessions/${SESSION_ID}:sendMessage" \
              -H "Content-Type: application/json" \
              -H "X-Goog-Api-Key: ${JULES_API_KEY}" \
              -d "$(jq -n --arg msg "$MESSAGE" '{message: $msg}')" && exit 0 || true
          fi

          # Create new session if messaging failed or no session exists
          BASE_SHA=$(git rev-parse "origin/${BASE_BRANCH}")
          CHANGED_FILES=$(echo "$PR_JSON" | jq -r '.files[].path' | sed 's/^/- /' | paste -sd'\n' -)

          PROMPT="FIX REQUEST for Pull Request #${PR_NUMBER}: ${PR_TITLE}

## Context
- **PR Number:** ${PR_NUMBER}
- **Current Branch:** \`${PR_BRANCH}\`
- **Base Branch:** \`${BASE_BRANCH}\`
- **Base Branch Current SHA:** \`${BASE_SHA}\`
- **Changed Files in this PR:**
${CHANGED_FILES}

## Original PR Description
${PR_BODY}

## Detected Problems to Fix
${FEEDBACK}${AUTONOMOUS_INSTRUCTION}

Please checkout the branch \`${PR_BRANCH}\`, investigate the failures, fix them, and push an update."

          curl -sf -X POST \
            "${JULES_BASE_URL}/sessions" \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: ${JULES_API_KEY}" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg title "Fix #${PR_NUMBER}: ${PR_TITLE}" \
              --arg branch "$PR_BRANCH" \
              '{
                prompt: $prompt,
                title: $title,
                sourceContext: {
                  source: "sources/github/franklinbaldo/egregora",
                  githubRepoContext: {startingBranch: $branch}
                },
                automationMode: "AUTO_CREATE_PR"
              }')"
