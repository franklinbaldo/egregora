name: Jules Auto-Fixer

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string

permissions:
  pull-requests: write  # Changed from 'read' to allow posting comments
  contents: read

env:
  PYTHON_VERSION: "3.12"

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    # Run if CI failed OR if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Identify PR
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          EVENT_FILE="${GITHUB_EVENT_PATH}"
          # Try to get PR URL directly from the event
          PR_URL=$(jq -r '.workflow_run.pull_requests[0].url // empty' "$EVENT_FILE")

          # If not present, try to find a PR by matching head SHA
          if [[ -z "$PR_URL" ]]; then
            HEAD_SHA=$(jq -r '.workflow_run.head_sha // empty' "$EVENT_FILE")
            if [[ -n "$HEAD_SHA" ]]; then
              # List all PRs (state=all) and look for one whose head.sha matches the run head SHA
              PR_URL=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=all" \
                | jq -r --arg sha "$HEAD_SHA" '.[] | select(.head.sha == $sha) | .url' | head -n1)
            fi
          fi

          if [[ -z "$PR_URL" ]]; then
            echo "No pull request associated with this workflow_run; skipping Jules auto-fix."
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_JSON=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "$PR_URL")
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')

          if [[ -z "$PR_NUMBER" ]]; then
            echo "Failed to determine PR number from $PR_URL"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run auto-fix for ALL PRs (not just Jules PRs)
          echo "has_pr=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Wait for Gemini Review
        if: steps.pr-info.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          echo "Checking for Gemini PR Code Review workflow for PR #$PR_NUMBER..."

          # Get the head SHA for this PR
          HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          echo "PR head SHA: $HEAD_SHA"

          # Wait for up to 10 minutes (600 seconds) for Gemini review to complete
          MAX_WAIT=600
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get all workflow runs for "Gemini PR Code Review" on this commit
            GEMINI_RUNS=$(gh api "/repos/${GITHUB_REPOSITORY}/actions/workflows/gemini-pr-review.yml/runs?head_sha=${HEAD_SHA}&per_page=5" \
              --jq '.workflow_runs[] | select(.event == "pull_request") | {id, status, conclusion}')

            if [ -z "$GEMINI_RUNS" ]; then
              echo "No Gemini review workflow found for this PR yet. Waiting..."
            else
              # Check if any run is completed
              STATUS=$(echo "$GEMINI_RUNS" | jq -r '.status' | head -n1)
              CONCLUSION=$(echo "$GEMINI_RUNS" | jq -r '.conclusion' | head -n1)

              echo "Gemini workflow status: $STATUS, conclusion: $CONCLUSION"

              if [ "$STATUS" = "completed" ]; then
                echo "✅ Gemini review completed with conclusion: $CONCLUSION"
                break
              fi

              echo "Gemini review still running..."
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            echo "Waited ${ELAPSED}s / ${MAX_WAIT}s"
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "⚠️ Timeout waiting for Gemini review. Proceeding anyway..."
          fi

      - name: Trigger Jules Auto-Fix
        if: steps.pr-info.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          PYTHONPATH: .team
        run: |
          # All dependencies (httpx, requests, pydantic, typer) are in pyproject.toml
          uv run python -m repo.cli autofix analyze ${{ steps.pr-info.outputs.pr_number }}
