name: Jules Auto-Fixer

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string

permissions:
  pull-requests: write  # Changed from 'read' to allow posting comments
  contents: read

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    # Run if CI failed OR if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.12"
          extras: "--all-extras"

      - name: Identify PR
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "is_jules=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          EVENT_FILE="${GITHUB_EVENT_PATH}"
          # Try to get PR URL directly from the event
          PR_URL=$(jq -r '.workflow_run.pull_requests[0].url // empty' "$EVENT_FILE")

          # If not present, try to find a PR by matching head SHA
          if [[ -z "$PR_URL" ]]; then
            HEAD_SHA=$(jq -r '.workflow_run.head_sha // empty' "$EVENT_FILE")
            if [[ -n "$HEAD_SHA" ]]; then
              # List all PRs (state=all) and look for one whose head.sha matches the run head SHA
              PR_URL=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=all" \
                | jq -r --arg sha "$HEAD_SHA" '.[] | select(.head.sha == $sha) | .url' | head -n1)
            fi
          fi

          if [[ -z "$PR_URL" ]]; then
            echo "No pull request associated with this workflow_run; skipping Jules auto-fix."
            echo "is_jules=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_JSON=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "$PR_URL")
          PR_USER=$(echo "$PR_JSON" | jq -r '.user.login // empty')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')

          if [[ -z "$PR_NUMBER" ]]; then
            echo "Failed to determine PR number from $PR_URL"
            echo "is_jules=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$PR_USER" == "google-labs-jules[bot]" ]]; then
            echo "is_jules=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "is_jules=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Jules Auto-Fix
        if: steps.pr-info.outputs.is_jules == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # For gh CLI to post comments
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          PYTHONPATH: .jules
        run: |
          uv run --with requests --with typer --with pydantic python -m jules.cli autofix analyze ${{ steps.pr-info.outputs.pr_number }}
