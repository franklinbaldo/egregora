name: Auto-rebase open PRs when main updates

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-rebase-on-main
  cancel-in-progress: true

jobs:
  auto-rebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Install GitHub CLI
        uses: cli/gh-action@v2
        with:
          github_token: ${{ github.token }}

      - name: Rebase all open PRs targeting main
        env:
          GH_TOKEN: ${{ github.token }}
          SHA_SHORT: ${{ github.sha }}
        run: |
          set -euo pipefail

          # All open PRs to base=main (include branch + fork info)
          prs_json="$(gh pr list --base main --state open --json number,headRefName,isCrossRepository)"
          echo "Found $(jq 'length' <<<"$prs_json") open PR(s) targeting main."

          git fetch origin main

          jq -c '.[]' <<<"$prs_json" | while read -r pr; do
            num=$(jq -r '.number' <<<"$pr")
            head=$(jq -r '.headRefName' <<<"$pr")
            cross=$(jq -r '.isCrossRepository' <<<"$pr")

            echo "::group::PR #$num — $head"

            # We can only push to same-repo branches with GITHUB_TOKEN
            if [[ "$cross" == "true" ]]; then
              echo "Fork PR: cannot force-push."
              gh pr comment "$num" --body "ℹ️ Auto-rebase skipped: this PR comes from a fork, so the repository cannot push to the branch automatically."
              echo "::endgroup::"
              continue
            fi

            # Ensure local tracking branch is up-to-date
            git fetch --prune origin "$head:$head" || {
              echo "Branch $head not found on origin; skipping."
              echo "::endgroup::"
              continue
            }

            # Skip if already contains latest main
            if git merge-base --is-ancestor origin/main "$head"; then
              echo "Already up to date with main."
              echo "::endgroup::"
              continue
            fi

            git checkout "$head"

            set +e
            git rebase --rebase-merges origin/main
            status=$?
            set -e

            if [[ $status -eq 0 ]]; then
              git push --force-with-lease origin "$head"
              gh pr comment "$num" --body "✅ Auto-rebase: successfully rebased onto \`main@${SHA_SHORT::7}\` and force-pushed."
            else
              git rebase --abort || true
              gh pr comment "$num" --body "❌ Auto-rebase: conflicts detected rebasing onto current \`main\`. Please resolve by rebasing locally (or use **Update branch** if available)."
            fi

            echo "::endgroup::"
          done
