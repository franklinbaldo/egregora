name: Demo Blog (DEPRECATED - Integrated into pages.yml)

# DEPRECATED: This workflow has been integrated into pages.yml
# The demo blog is now built and deployed together with the main documentation
# Keeping this file for reference but it will never trigger

# Security: Limit permissions to minimum required for deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "demo-pages"
  cancel-in-progress: false

on:
  # Disabled - only manual trigger available for testing/reference
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: https://franklinbaldo.github.io/egregora/demo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install egregora with all dependencies
        run: uv sync --all-extras

      # CRITICAL: Restore DuckDB database and cache to achieve <90s runs after first build
      - name: Restore pipeline cache
        uses: actions/cache@v4
        with:
          path: |
            pipeline.duckdb
            pipeline.duckdb.wal
            .egregora-cache/
            .egregora/lancedb/
          key: demo-pipeline-${{ hashFiles('tests/fixtures/Conversa do WhatsApp com Teste.zip') }}-v2
          restore-keys: |
            demo-pipeline-${{ hashFiles('tests/fixtures/Conversa do WhatsApp com Teste.zip') }}-
            demo-pipeline-

      # Generate the blog using the built-in fixture
      - name: Generate demo blog
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "ðŸš€ Generating demo blog from fixture..."
          uv run egregora write \
            "tests/fixtures/Conversa do WhatsApp com Teste.zip" \
            --output=./demo-output \
            --resume

          echo "âœ… Blog generation complete"
          ls -lah demo-output/posts/ || echo "âš ï¸  No posts directory found"

      # CRITICAL: Fail loudly if fewer than 6 posts were generated
      - name: Validate output quality
        run: |
          POST_COUNT=$(find demo-output/posts -name "*.md" -type f ! -name "index.md" | wc -l)
          echo "ðŸ“Š Generated $POST_COUNT blog posts"

          if [ "$POST_COUNT" -lt 6 ]; then
            echo "âŒ FAILURE: Only $POST_COUNT posts generated (minimum: 6)"
            echo "This indicates the pipeline is broken or cache is corrupted"
            exit 1
          fi

          echo "âœ… Quality check passed: $POST_COUNT posts generated"

      # Build the MkDocs site
      - name: Build MkDocs site
        run: |
          cd demo-output
          uvx --with mkdocs-material --with mkdocs-blogging-plugin mkdocs build
          echo "âœ… MkDocs site built successfully"

      # Prepare deployment to /demo subfolder
      - name: Prepare Pages deployment
        run: |
          # Create root index.html that redirects to /demo
          mkdir -p pages-root
          cat > pages-root/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=/egregora/demo/">
            <link rel="canonical" href="/egregora/demo/">
            <title>Redirecting to Egregora Demo...</title>
          </head>
          <body>
            <p>Redirecting to <a href="/egregora/demo/">demo blog</a>...</p>
          </body>
          </html>
          EOF

          # Move MkDocs output to /demo subfolder
          mv demo-output/site pages-root/demo

          echo "ðŸ“¦ Pages structure ready:"
          ls -lah pages-root/
          ls -lah pages-root/demo/ | head -20

      # Upload artifact for GitHub Pages
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages-root

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Demo Blog Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://franklinbaldo.github.io/egregora/demo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Posts Generated:** $(find demo-output/posts -name "*.md" -type f ! -name "index.md" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Cache Status:** $([ -f pipeline.duckdb ] && echo 'âœ… Warm' || echo 'â„ï¸  Cold (first run)')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next rebuild: Nightly at 2 AM UTC or on next push to main" >> $GITHUB_STEP_SUMMARY
