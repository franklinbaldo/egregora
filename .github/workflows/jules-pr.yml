name: Jules PR

# ==============================================================================
# JULES PR AUTOMATION WORKFLOW
# ==============================================================================
#
# This workflow handles PR-level automation for Jules. It runs in response to
# PR events and CI completions.
#
# JOBS IN THIS WORKFLOW:
# ======================
#
#   auto-merge:   Enable auto-merge for Jules PRs
#   auto-fixer:   Analyze CI failures and trigger fixes
#
# AUTO-MERGE FLOW:
# ================
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                                                                         â”‚
#   â”‚   1. Jules creates a PR (from jules.yml scheduler session)              â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   2. pull_request_target event fires                                    â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   3. Check if author is Jules (google-labs-jules[bot])                  â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   4. If draft â†’ mark as ready for review                                â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   5. Enable auto-merge with --delete-branch                             â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   6. When all checks pass â†’ PR auto-merges                              â”‚
#   â”‚                                                                         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# AUTO-FIXER FLOW:
# ================
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                                                                         â”‚
#   â”‚   1. CI workflow completes with failure                                 â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   2. workflow_run event fires (conclusion == 'failure')                 â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   3. Identify which PR caused the failure                               â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   4. Run `repo.cli autofix analyze` on the PR                           â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   5. Sends fix instructions to Jules session                            â”‚
#   â”‚      â†“                                                                  â”‚
#   â”‚   6. Jules pushes fix â†’ CI runs again                                   â”‚
#   â”‚                                                                         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# SECURITY NOTES:
# ===============
#
#   - Uses pull_request_target (has write access to base repo)
#   - MUST verify PR is from same repo (not a fork) before running
#   - Fork PRs are silently skipped to prevent secret exposure
#
# IMPORTANT: Do not remove the fork check. It prevents malicious fork PRs
# from accessing repository secrets.
#
# ==============================================================================

on:
  # Auto-merge trigger
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

  # Auto-fixer triggers
  workflow_run:
    workflows: ["CI"]
    types: [completed]

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze and fix'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ==========================================================================
  # AUTO-MERGE: Enable auto-merge for Jules PRs
  # ==========================================================================
  auto-merge:
    name: Auto-Merge
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    # Security: only run for PRs from same repo (not forks)
    concurrency:
      group: jules-auto-merge-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Checkout scripts
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts/jules

      - name: Enable auto-merge
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/jules/enable-auto-merge.sh "${{ github.event.pull_request.number }}"

  # ==========================================================================
  # AUTO-FIXER: Fix CI failures automatically
  # ==========================================================================
  auto-fixer:
    name: Auto-Fixer
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          extras: "--extra jules"

      - name: Identify PR (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: manual-pr
        run: |
          echo "has_pr=true" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT

      - name: Identify PR (workflow_run)
        if: github.event_name == 'workflow_run'
        id: workflow-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/jules/identify-pr.sh "$GITHUB_EVENT_PATH"

      - name: Run auto-fix
        if: |
          steps.manual-pr.outputs.has_pr == 'true' ||
          steps.workflow-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          PYTHONPATH: .team
        run: |
          PR_NUMBER="${{ steps.manual-pr.outputs.pr_number || steps.workflow-pr.outputs.pr_number }}"
          echo "ðŸ”§ Running auto-fix for PR #$PR_NUMBER"
          uv run python -m repo.cli autofix analyze "$PR_NUMBER"
