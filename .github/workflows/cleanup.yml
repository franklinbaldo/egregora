name: Cleanup Old Artifacts

on:
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:

permissions:
  actions: write

jobs:
  cleanup:
    name: Delete old artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Delete artifacts older than 30 days
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Calculate cutoff date (30 days ago)
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30);

            console.log(`Deleting artifacts older than ${cutoffDate.toISOString()}`);

            let deletedCount = 0;
            let totalSize = 0;

            // Paginate through all artifacts
            for await (const response of github.paginate.iterator(
              github.rest.actions.listArtifactsForRepo,
              {
                owner,
                repo,
                per_page: 100,
              }
            )) {
              for (const artifact of response.data) {
                const createdAt = new Date(artifact.created_at);

                if (createdAt < cutoffDate) {
                  console.log(`Deleting: ${artifact.name} (${artifact.size_in_bytes} bytes, created ${artifact.created_at})`);

                  try {
                    await github.rest.actions.deleteArtifact({
                      owner,
                      repo,
                      artifact_id: artifact.id,
                    });

                    deletedCount++;
                    totalSize += artifact.size_in_bytes;
                  } catch (error) {
                    console.error(`Failed to delete artifact ${artifact.id}: ${error.message}`);
                  }
                }
              }
            }

            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);

            console.log(`\nâœ… Cleanup complete!`);
            console.log(`   Deleted: ${deletedCount} artifacts`);
            console.log(`   Freed: ${totalSizeMB} MB`);

            // Post summary
            core.summary
              .addHeading('Artifact Cleanup Summary')
              .addTable([
                [{data: 'Metric', header: true}, {data: 'Value', header: true}],
                ['Artifacts Deleted', deletedCount.toString()],
                ['Storage Freed', `${totalSizeMB} MB`],
                ['Cutoff Date', cutoffDate.toISOString()],
              ])
              .write();
