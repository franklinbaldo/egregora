name: Gemini PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

# üõë Concurrency: Cancel old runs on the same PR to save costs
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run if:
    # 1. It's a non-draft PR
    # 2. OR It's a comment on a PR starting with @gemini
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@gemini'))

    steps:
      - name: üîç Setup & Security Checks
        id: setup
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const eventName = context.eventName;
            let prData = {};

            // --- 1. Get PR Details ---
            if (eventName === 'issue_comment') {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              prData = pr;
            } else {
              prData = context.payload.pull_request;
            }

            const isFork = prData.head.repo.full_name !== prData.base.repo.full_name;

            // --- 2. Security: Check Secrets & Permissions ---
            // If this is an automatic run on a fork, secrets are missing. We must skip.
            if (!process.env.GEMINI_API_KEY) {
              if (isFork && eventName === 'pull_request') {
                console.log("‚ÑπÔ∏è Fork detected on automatic trigger. Skipping (No secrets access).");
                console.log("üí° To review this fork, a maintainer must comment '@gemini' on the PR.");
                core.setOutput('skip', 'true');
                return { skip: true };
              } else {
                core.setFailed("‚ùå GEMINI_API_KEY is missing in Repo Secrets.");
                return;
              }
            }

            // If manual trigger on a Fork, ensure the user is a maintainer
            if (eventName === 'issue_comment' && isFork) {
              const username = context.payload.comment.user.login;
              try {
                await github.rest.repos.checkCollaborator({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  username: username
                });
                console.log(`‚úÖ Maintainer verified: ${username}`);
              } catch (e) {
                core.setFailed(`‚ùå Security: User @${username} is not a collaborator. Cannot trigger review on fork.`);
                return;
              }
            }

            // --- 3. Extract Instructions ---
            let comment = '';
            let mode = 'automatic';
            if (eventName === 'issue_comment') {
              const match = context.payload.comment.body.match(/@gemini\s*(.*)/s);
              comment = match ? match[1].trim() : '';
              mode = 'comment';
            }

            // --- 4. Set Outputs ---
            core.setOutput('skip', 'false');
            core.setOutput('pr_number', prData.number);
            core.setOutput('head_sha', prData.head.sha);
            core.setOutput('base_ref', prData.base.ref);
            core.setOutput('head_clone_url', prData.head.repo?.clone_url || '');
            core.setOutput('head_ref', prData.head.ref);
            core.setOutput('head_repo_full_name', prData.head.repo?.full_name || '');
            core.setOutput('base_repo_full_name', prData.base.repo?.full_name || '');
            core.setOutput('user_comment', comment);
            core.setOutput('trigger_mode', mode);

      - name: üì• Checkout Base (Trusted Scripts)
        if: steps.setup.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.setup.outputs.base_ref }}
          fetch-depth: 1 # Lightweight checkout

      - name: üì• Checkout PR Head (Analysis Target)
        if: steps.setup.outputs.skip != 'true'
        env:
          HEAD_SHA: ${{ steps.setup.outputs.head_sha }}
          HEAD_REF: ${{ steps.setup.outputs.head_ref }}
          HEAD_CLONE_URL: ${{ steps.setup.outputs.head_clone_url }}
          HEAD_REPO_FULL_NAME: ${{ steps.setup.outputs.head_repo_full_name }}
          BASE_REPO_FULL_NAME: ${{ steps.setup.outputs.base_repo_full_name }}
          PR_NUMBER: ${{ steps.setup.outputs.pr_number }}
        run: |
          set -euo pipefail

          TARGET_SHA="$HEAD_SHA"

          if [ "$HEAD_REPO_FULL_NAME" = "$BASE_REPO_FULL_NAME" ]; then
            echo "Fetching head commit from origin (same repository)."
            git fetch origin "$HEAD_SHA" --depth=1
          else
            echo "Fork detected from $HEAD_REPO_FULL_NAME. Attempting to fetch from fork origin."
            if git fetch --depth=1 "$HEAD_CLONE_URL" "$HEAD_REF"; then
              echo "Successfully fetched from fork remote."
            else
              echo "‚ö†Ô∏è Failed to fetch from fork remote. Falling back to PR refs."
              if git fetch origin "refs/pull/${PR_NUMBER}/head" --depth=1; then
                TARGET_SHA="$(git rev-parse FETCH_HEAD)"
                echo "Fetched from refs/pull/${PR_NUMBER}/head using commit $TARGET_SHA."
              else
                echo "‚ùå Unable to fetch PR head from refs/pull/${PR_NUMBER}/head."
                exit 1
              fi
            fi
          fi

          git worktree add pr-code "$TARGET_SHA"

      - name: üì¶ Setup Node & Install Deps
        if: steps.setup.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì• Install Script Dependencies
        if: steps.setup.outputs.skip != 'true'
        run: npm install @google/generative-ai @octokit/rest dotenv --no-save

      - name: üìÑ Generate Context (Repomix)
        if: steps.setup.outputs.skip != 'true'
        run: |
          # Run Repomix from the trusted checkout so PR-provided node_modules cannot
          # shadow the CLI. Copy our vetted ignore file into the worktree so the
          # generated context matches local expectations.
          [ -f .repomixignore ] && cp .repomixignore pr-code/.repomixignore

          # Always execute the published Repomix package (not anything from pr-code)
          # and explicitly point it at the untrusted checkout via a path argument so
          # we never need to cd into pr-code where attacker-controlled scripts might
          # run with repository secrets in scope.
          npx --yes --package repomix@1.9.1 repomix ./pr-code \
            --output repomix.txt \
            --ignore "**/*.lock,**/package-lock.json,**/node_modules/**,**/*.png,**/*.jpg"

          echo "‚úÖ Repository context generated."

      - name: üìÑ Fetch Diff & Chat History
        if: steps.setup.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = parseInt('${{ steps.setup.outputs.pr_number }}');

            // 1. Get Diff
            const diff = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              mediaType: { format: "diff" }
            });
            fs.writeFileSync('pr.patch', diff.data);

            // 2. Get Comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            fs.writeFileSync('pr-comments.json', JSON.stringify(comments.data));

      - name: ü§ñ Run Gemini Review
        if: steps.setup.outputs.skip != 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-3-pro-preview' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.setup.outputs.pr_number }}
          REPO_FULL_NAME: ${{ github.repository }}
          TRIGGER_MODE: ${{ steps.setup.outputs.trigger_mode }}
          USER_COMMENT: ${{ steps.setup.outputs.user_comment }}
        run: node .github/scripts/gemini-pr-review.js

      - name: üßπ Cleanup & Debug Artifacts
        if: failure() # Only upload on failure to debug
        uses: actions/upload-artifact@v4
        with:
          name: debug-context
          path: |
            repomix.txt
            pr.patch
            pr-comments.json
          retention-days: 3
