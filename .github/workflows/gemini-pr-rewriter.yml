name: Gemini PR Title & Description Rewriter

on:
  pull_request:
    types: [opened]

# Don't run multiple times for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  rewrite-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip draft PRs and PRs created by bots
    if: |
      !github.event.pull_request.draft &&
      !contains(github.event.pull_request.user.login, 'bot') &&
      !contains(github.event.pull_request.user.login, '[bot]')

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prData = context.payload.pull_request;

            core.setOutput('pr_number', prNumber);
            core.setOutput('base_ref', prData.base.ref);
            core.setOutput('head_sha', prData.head.sha);
            core.setOutput('base_sha', prData.base.sha);
            core.setOutput('pr_title', prData.title);
            core.setOutput('pr_body', prData.body || '(No description provided)');
            core.setOutput('pr_author', prData.user.login);

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Collect PR context
        id: collect
        env:
          BASE_SHA: ${{ steps.pr.outputs.base_sha }}
          BASE_REF: ${{ steps.pr.outputs.base_ref }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
          PR_TITLE: ${{ steps.pr.outputs.pr_title }}
          PR_BODY: ${{ steps.pr.outputs.pr_body }}
        run: |
          set -euo pipefail

          # Ensure we have the base ref locally
          git fetch origin "${BASE_REF}"

          # Get unified diff between base and head
          git diff --unified=3 "origin/${BASE_REF}" "${HEAD_SHA}" > pr.diff

          # Trim diff to avoid blowing the context window (60KB ~= 15k tokens)
          head -c 60000 pr.diff > pr-trimmed.diff

          # Warn if diff was truncated
          if [ $(wc -c < pr.diff) -gt 60000 ]; then
            echo "‚ö†Ô∏è WARNING: Diff truncated at 60KB." >> pr-trimmed.diff
          fi

          # Get commit messages to understand intent
          git log --format="%h - %s%n%b" "origin/${BASE_REF}..${HEAD_SHA}" > commits.txt || echo "(No commits found)" > commits.txt

          # Get list of changed files
          git diff --name-status "origin/${BASE_REF}" "${HEAD_SHA}" > changed-files.txt || echo "(No files changed)" > changed-files.txt

          # Output for the next step using unique delimiters
          RANDOM_ID="${{ github.run_id }}_${{ github.run_attempt }}_$(date +%s%N)"
          DIFF_DELIMITER="ghadelimiter_diff_${RANDOM_ID}"
          COMMITS_DELIMITER="ghadelimiter_commits_${RANDOM_ID}"
          FILES_DELIMITER="ghadelimiter_files_${RANDOM_ID}"
          PR_BODY_DELIMITER="ghadelimiter_pr_body_${RANDOM_ID}"

          {
            echo "diff<<${DIFF_DELIMITER}"
            cat pr-trimmed.diff
            echo "${DIFF_DELIMITER}"
            echo "commits<<${COMMITS_DELIMITER}"
            cat commits.txt
            echo "${COMMITS_DELIMITER}"
            echo "changed_files<<${FILES_DELIMITER}"
            cat changed-files.txt
            echo "${FILES_DELIMITER}"
            echo "pr_body<<${PR_BODY_DELIMITER}"
            echo "$PR_BODY"
            echo "${PR_BODY_DELIMITER}"
          } >> "$GITHUB_OUTPUT"

      - name: Construct Gemini Prompt
        id: construct_prompt
        uses: actions/github-script@v8
        env:
          DIFF: ${{ steps.collect.outputs.diff }}
          COMMITS: ${{ steps.collect.outputs.commits }}
          CHANGED_FILES: ${{ steps.collect.outputs.changed_files }}
          PR_BODY: ${{ steps.collect.outputs.pr_body }}
          PR_TITLE: ${{ steps.pr.outputs.pr_title }}
          PR_AUTHOR: ${{ steps.pr.outputs.pr_author }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the prompt template
            const promptTemplate = fs.readFileSync('.github/prompts/pr-rewriter-prompt.md', 'utf8');

            // Replace placeholders with actual values
            const prompt = promptTemplate
              .replace(/\{\{PR_NUMBER\}\}/g, process.env.PR_NUMBER)
              .replace(/\{\{PR_AUTHOR\}\}/g, process.env.PR_AUTHOR)
              .replace(/\{\{PR_TITLE\}\}/g, process.env.PR_TITLE)
              .replace(/\{\{PR_BODY\}\}/g, process.env.PR_BODY)
              .replace(/\{\{COMMITS\}\}/g, process.env.COMMITS)
              .replace(/\{\{CHANGED_FILES\}\}/g, process.env.CHANGED_FILES)
              .replace(/\{\{DIFF\}\}/g, process.env.DIFF);

            core.exportVariable('GEMINI_PROMPT', prompt);

      # ----------------------------------------------------------------------
      # Gemini Rewrite Pipeline with Fallback Strategy
      # 1. Gemini 2.5 Flash (Fast, good quality, lower cost)
      # 2. Gemini 2.5 Flash Lite (Cheapest fallback)
      # ----------------------------------------------------------------------

      - name: Run Gemini PR Rewriter (Flash)
        id: gemini_flash
        continue-on-error: true
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-flash"
          prompt: ${{ env.GEMINI_PROMPT }}

      - name: Run Gemini PR Rewriter (Flash Lite)
        id: gemini_lite
        if: steps.gemini_flash.outcome == 'failure'
        continue-on-error: true
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-flash-lite"
          prompt: ${{ env.GEMINI_PROMPT }}

      - name: Consolidate Gemini Results
        id: gemini_final
        if: always()
        uses: actions/github-script@v8
        env:
          OUTCOME_FLASH: ${{ steps.gemini_flash.outcome }}
          SUMMARY_FLASH: ${{ steps.gemini_flash.outputs.summary }}
          OUTCOME_LITE: ${{ steps.gemini_lite.outcome }}
          SUMMARY_LITE: ${{ steps.gemini_lite.outputs.summary }}
        with:
          script: |
            const outcomes = {
              flash: process.env.OUTCOME_FLASH,
              lite: process.env.OUTCOME_LITE
            };

            const summaries = {
              flash: process.env.SUMMARY_FLASH,
              lite: process.env.SUMMARY_LITE
            };

            let finalOutcome = 'failure';
            let finalSummary = '';
            let finalModel = 'unknown';

            if (outcomes.flash === 'success') {
              finalOutcome = 'success';
              finalSummary = summaries.flash;
              finalModel = 'gemini-2.5-flash';
            } else if (outcomes.lite === 'success') {
              finalOutcome = 'success';
              finalSummary = summaries.lite;
              finalModel = 'gemini-2.5-flash-lite';
            }

            core.setOutput('outcome', finalOutcome);
            core.setOutput('model', finalModel);
            core.setOutput('summary', finalSummary);

            console.log(`Final Model: ${finalModel}`);
            console.log(`Final Outcome: ${finalOutcome}`);

      - name: Parse Gemini Response and Update PR
        if: steps.gemini_final.outputs.outcome == 'success'
        uses: actions/github-script@v8
        env:
          GEMINI_RESPONSE: ${{ steps.gemini_final.outputs.summary }}
          GEMINI_MODEL: ${{ steps.gemini_final.outputs.model }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          CURRENT_TITLE: ${{ steps.pr.outputs.pr_title }}
          CURRENT_BODY: ${{ steps.pr.outputs.pr_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            let geminiResponse = process.env.GEMINI_RESPONSE;
            const geminiModel = process.env.GEMINI_MODEL;
            const currentTitle = process.env.CURRENT_TITLE;
            const currentBody = process.env.CURRENT_BODY;

            console.log('Raw Gemini response:', geminiResponse);

            // Extract JSON from markdown code blocks if present
            const jsonMatch = geminiResponse.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch) {
              geminiResponse = jsonMatch[1];
            }

            let response;
            try {
              response = JSON.parse(geminiResponse);
            } catch (error) {
              console.error('Failed to parse Gemini response as JSON:', error);
              console.error('Response was:', geminiResponse);

              // Post a comment about the parsing failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ‚ö†Ô∏è PR Rewriter Notice

            The Gemini PR rewriter workflow ran but failed to parse the AI response.

            This is likely a temporary issue. The workflow will try again if you close and reopen this PR.

            ---
            *Attempted with ${geminiModel}*`
              });
              return;
            }

            if (!response.needs_rewrite) {
              // PR is already good, post a positive comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ‚úÖ PR Title & Description Look Good!

            ${response.reasoning || 'The PR title and description are clear and professional.'}

            ---
            *Reviewed by ${geminiModel}*`
              });
              console.log('PR does not need rewriting.');
              return;
            }

            // Validate that we have the required fields
            if (!response.title || !response.description) {
              console.error('Invalid response: missing title or description');
              return;
            }

            // Update the PR
            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                title: response.title,
                body: response.description
              });

              console.log('‚úÖ PR updated successfully!');

              // Post a comment explaining the changes
              const changes = [];
              if (response.title !== currentTitle) {
                changes.push(`**Title:**\n- Before: \`${currentTitle}\`\n- After: \`${response.title}\``);
              }
              if (response.description !== currentBody) {
                changes.push(`**Description:** Updated to be more clear and informative`);
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ü§ñ PR Title & Description Updated

            I've improved the PR title and description to make them more clear and professional.

            ### What Changed

            ${changes.join('\n\n')}

            ### Reasoning

            ${response.reasoning}

            ---
            *If you prefer the original title/description, feel free to change them back. This is just a suggestion to help improve clarity.*

            *Rewritten by ${geminiModel}*`
              });

            } catch (error) {
              console.error('Failed to update PR:', error);

              // Post a comment with the suggestions instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## üí° PR Title & Description Suggestions

            I tried to update your PR title and description but encountered an error. Here are my suggestions:

            ### Suggested Title
            \`\`\`
            ${response.title}
            \`\`\`

            ### Suggested Description
            ${response.description}

            ### Reasoning
            ${response.reasoning}

            ---
            *Suggestions from ${geminiModel}*`
              });
            }

      - name: Handle Gemini Failure
        if: steps.gemini_final.outputs.outcome != 'success'
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ‚ö†Ô∏è PR Rewriter Workflow Failed

            The Gemini PR rewriter workflow failed to complete.

            Possible causes:
            - **API Key Issues:** The \`GEMINI_API_KEY\` secret may be missing or invalid
            - **Quota/Rate Limiting:** API quota may be exhausted
            - **Timeout:** The request took too long

            ### Debugging Steps

            1. **Check Secrets:** Verify that \`GEMINI_API_KEY\` is set in repository secrets
            2. **Review Logs:** Check the [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error messages

            ---
            *This is an automated workflow - you can safely ignore this if your PR title and description are already clear.*`
            });
