From 6c96895f4094f37060d282234b15631843687e2b Mon Sep 17 00:00:00 2001
From: "google-labs-jules[bot]"
 <161369871+google-labs-jules[bot]@users.noreply.github.com>
Date: Tue, 13 Jan 2026 19:06:08 +0000
Subject: [PATCH] =?UTF-8?q?refactor(data):=20=F0=9F=93=89=20Remove=20dupli?=
 =?UTF-8?q?cated=20slug=20logic?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Removes the duplicated hash calculation logic from the `slug` property in the `Document` class.

The fallback logic for the `slug` property was re-implementing the same content hashing and UUID generation that is already handled by the `document_id` property.

This change removes the duplicated logic and reuses the `document_id` property, applying the DRY principle. This makes the code shorter, easier to understand, and less prone to future bugs if the hashing logic ever needs to change.
---
 ...01-13-1905-Remove_Duplicated_Slug_Logic.md | 15 +++++++
 src/egregora/data_primitives/document.py      | 10 +----
 tests/unit/data_primitives/test_document.py   | 39 +++++++++++++++++++
 3 files changed, 56 insertions(+), 8 deletions(-)
 create mode 100644 .team/personas/simplifier/journals/2026-01-13-1905-Remove_Duplicated_Slug_Logic.md
 create mode 100644 tests/unit/data_primitives/test_document.py

diff --git a/.team/personas/simplifier/journals/2026-01-13-1905-Remove_Duplicated_Slug_Logic.md b/.team/personas/simplifier/journals/2026-01-13-1905-Remove_Duplicated_Slug_Logic.md
new file mode 100644
index 000000000..80e4c847b
--- /dev/null
+++ b/.team/personas/simplifier/journals/2026-01-13-1905-Remove_Duplicated_Slug_Logic.md
@@ -0,0 +1,15 @@
+---
+title: "ðŸ“‰ Remove Duplicated Slug Logic"
+date: 2026-01-13
+author: "Simplifier"
+emoji: "ðŸ“‰"
+type: journal
+---
+
+## ðŸ“‰ 2026-01-13 - Summary
+
+**Observation:** The  property in  contained duplicated logic for calculating a content-based UUID, which was already handled in the  property. This redundancy increased complexity and violated the DRY principle.
+
+**Action:** I first created a new test to lock in the existing behavior of the  property. Then, I refactored the  property to remove the duplicated hash calculation logic and replaced it with a call to . I then ran the tests again to ensure the change was behavior-preserving.
+
+**Reflection:** This was a successful simplification that reduced code duplication and improved maintainability. It also reinforced the importance of TDD, as the initial attempt to simplify  was correctly identified as a regression by the code review process. The  directory might contain other opportunities for simplification, and I should continue to look for duplicated logic in other parts of the codebase.
diff --git a/src/egregora/data_primitives/document.py b/src/egregora/data_primitives/document.py
index b7e08a642..0fefaa1a9 100644
--- a/src/egregora/data_primitives/document.py
+++ b/src/egregora/data_primitives/document.py
@@ -186,14 +186,8 @@ def slug(self) -> str:
         if self.id:
             return self.id

-        # Fallback: calculate hash-based ID and take first 8 chars
-        # We manually calculate UUID to avoid recursion
-        if isinstance(self.content, bytes):
-            payload = self.content
-        else:
-            payload = self.content.encode("utf-8")
-        content_hash = hashlib.sha256(payload).hexdigest()
-        return str(uuid5(NAMESPACE_DOCUMENT, content_hash))[:8]
+        # Fallback: use the first 8 characters of the full document_id
+        return self.document_id[:8]

     def with_parent(self, parent: Document | str) -> Document:
         """Return new document with parent relationship."""
diff --git a/tests/unit/data_primitives/test_document.py b/tests/unit/data_primitives/test_document.py
new file mode 100644
index 000000000..3937acabf
--- /dev/null
+++ b/tests/unit/data_primitives/test_document.py
@@ -0,0 +1,39 @@
+
+from __future__ import annotations
+
+from uuid import UUID
+
+import pytest
+
+from egregora.data_primitives.document import Document, DocumentType
+
+
+@pytest.mark.parametrize(
+    ("content", "metadata", "expected_slug"),
+    [
+        ("test content", {}, "da947fba"),
+        ("test content", {"slug": "   "}, "da947fba"),
+        ("different content", {}, "b578faa2"),
+        (b"binary content", {}, "6bc78833"),
+    ],
+    ids=[
+        "no_slug_falls_back_to_uuid",
+        "blank_slug_falls_back_to_uuid",
+        "different_content_different_uuid",
+        "binary_content_uuid",
+    ],
+)
+def test_slug_fallback_behavior(content: str | bytes, metadata: dict, expected_slug: str):
+    """Verify that slug property falls back to UUID when no slug is provided."""
+    doc = Document(content=content, type=DocumentType.POST, metadata=metadata)
+    assert doc.slug == expected_slug
+
+
+def test_slug_uses_metadata_when_present():
+    """Verify that slug property uses slug from metadata when present."""
+    doc = Document(
+        content="test content",
+        type=DocumentType.POST,
+        metadata={"slug": "my-custom-slug"},
+    )
+    assert doc.slug == "my-custom-slug"
