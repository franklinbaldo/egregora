{# DISABLED: Privacy module being removed #}
{# {% import '_privacy_macros.jinja' as privacy %} #}
{# {{ privacy.pii_prevention_block(pii_prevention, context="enrichment") }} #}

{% macro media_type_instructions(media_type) -%}
{% if media_type == "image" %}
- Treat this like a high-value archival photograph. Describe composition, subjects, environment, text or symbols, emotional tone, and any notable stylistic choices (filters, editing artifacts, resolution).
- If it resembles a meme, explain its format, template lineage, and likely cultural references.
{% elif media_type == "video" %}
- Summarize the key scenes chronologically. Mention camera style, pacing, soundtrack, and any onscreen text or cuts.
- Highlight actions, gestures, or reactions frame-by-frame where relevant.
{% elif media_type == "audio" %}
- Transcribe intelligible speech. If language differs from English, translate essential phrases.
- Describe tone, emotion, background sounds, music, and recording quality.
- Note if it feels like a meme-able sound bite (reaction audio, catchphrase, chant, etc.).
{% else %}
- Describe the file as precisely as possible (charts, infographics, documents, mixed media). Capture layout, key data, and any annotations.
{% endif %}
{%- endmacro %}

{% macro media_embed_block(media_type, media_path, media_filename) -%}
{% if media_type == "image" %}
![{{ media_filename }}](/{{ media_path }})
{% elif media_type == "video" %}
<video controls width="100%">
  <source src="/{{ media_path }}" type="video/mp4">
</video>
{% elif media_type == "audio" %}
<audio controls>
  <source src="/{{ media_path }}">
</audio>
{% else %}
[Download/view file](/{{ media_path }})
{% endif %}
{%- endmacro %}

{% if mode == "url_user" %}
URL: {{ sanitized_url }}

{% elif mode == "media_user" %}
FILE: {{ sanitized_filename }}{% if sanitized_mime %} ({{ sanitized_mime }}){% endif %}

{% elif mode == "url" %}
Generate a complete markdown enrichment file for this URL shared in a group conversation.

## URL to Analyze
{{ url }}

## Context
This link was shared in a private group conversation. The sharer's identity, original wording, and share timestamp must remain confidential.

Return JSON with `{ "slug": string, "markdown": string }`:

- `slug`: kebab-case identifier (≤ 60 characters) capturing the topic/source (e.g., `alignment-forum-mesa-optimizers`).
- `markdown`: the document described below.

## Output Format

Generate a complete markdown document following this structure:

```markdown
# Enrichment: [URL]

## Metadata
- **URL:** {{ url }}

## Content

### URL Preview
<iframe src="{{ url }}" width="100%" height="500" frameborder="0" loading="lazy"></iframe>

[Open in new tab]({{ url }})

## Analysis

---

## Summary
[2-3 paragraph comprehensive summary of the URL's content]

---

## Context
[Explain why this public content is relevant to ongoing themes without quoting or referencing the private message, sender, or share timestamp.]

---

## Key Takeaways
[Markdown bullet list of 3-5 key insights]

---

## Metadata
[Markdown bullet list: title, author, publication date, source, etc.]
```

Output ONLY the markdown. No preamble. No code fences. Raw markdown that can be saved directly to a .md file.

Do not reveal or quote the original sender, private message, or share timestamp; focus solely on the public content and inferred relevance.

{% elif mode == "media" %}
Generate a complete markdown enrichment file for this media shared in a group conversation.

This enrichment will be indexed for future retrieval, so be thorough and specific in your analysis.
If the media is a meme, provide detailed context about what situations it would be useful for - this helps
the writer agent find relevant memes when creating blog posts.

Your structured response must include two fields:

1. `slug` — a descriptive, kebab-case identifier (≤ 60 characters) that captures what the media depicts. Use the same slug for both the binary asset and this enrichment markdown.
2. `markdown` — the document described below.

## Media File
**Type:** {{ media_type }}
**Filename:** {{ media_filename }}
**Path:** {{ media_path }}

{% if media_type == "image" or media_type == "video" %}
The media file has been uploaded for your analysis.
{% endif %}

## Context
This media was shared privately. Preserve confidentiality—do not expose the sharer's identity, exact message, or share timestamp.

## Privacy Check

⚠️ **CRITICAL: Check for Personally Identifiable Information (PII)**

Before describing this media, scan carefully for any PII that could compromise privacy:

**Visual PII (Images/Videos):**
- Identifiable faces of real people
- License plates on vehicles
- Government-issued IDs (passports, driver's licenses, ID cards, health cards)
- Credit cards, debit cards, or financial documents
- Street addresses or house numbers visible in images
- Handwritten signatures
- Medical documents, prescriptions, or health records
- Phone numbers in screenshots or visible text
- Personal documents (contracts, legal papers, mail with addresses)
- Screen captures showing personal information (emails, messages, etc.)
- Name tags, badges, or identification visible on people

**Audio PII (Voice recordings):**
- Full names being spoken
- Phone numbers mentioned
- Street addresses mentioned
- Social security numbers or government IDs spoken
- Financial account numbers
- Email addresses spoken out loud

**If you find ANY PII:**

1. **Start your response with the exact code word:** `PII_DETECTED` (on its own line at the very beginning)
2. **Still provide a detailed description** BUT redact/omit the PII details
3. **DO NOT describe identifying features** (e.g., say "a person" instead of describing facial features)
4. **DO NOT include readable text containing PII** (e.g., say "a document" instead of transcribing ID numbers)
5. **DO NOT mention specific names, addresses, or phone numbers** visible in the media
6. Add a note in the Description section: `[This media contained personal information which has been redacted for privacy protection]`

**Example with PII detected:**
```
PII_DETECTED

# Enrichment: [Filename]
...
## Description
This image shows a person holding an identification document in an indoor setting. The photo appears to be taken with natural lighting coming from a window. The person is standing in what looks like a home environment.

[This media contained personal information which has been redacted for privacy protection]
...
```

**If NO PII is detected:**
- Proceed with normal detailed analysis
- Do NOT include the `PII_DETECTED` code word
- Describe everything normally

## Output Format

Generate a complete markdown document following this structure:

```markdown
# Enrichment: [Filename]

## Metadata
- **Media Type:** {{ media_type }}
- **File:** {{ media_path }}

## Content

### Media File
{{ media_embed_block(media_type, media_path, media_filename) }}

[Download](/{{ media_path }})

## Analysis

---

## Description
[2-3 paragraph detailed description of what you see/hear. Be specific. Use the following hints:]

{{ media_type_instructions(media_type) }}

---

## Context
[Explain how this media connects to ongoing themes without quoting or identifying the private sharer or mentioning share timestamps.]

---

## Visual/Audio Elements
[Markdown bullet list of key elements, composition, style, details]

---

## Relevance
[Why this matters. What ideas or concepts does it convey?]

---

## Meme Classification
**Is this a meme?** [Yes/No]

{% if media_type == "image" or media_type == "video" %}
If yes, provide:
- **Meme Type:** [e.g., reaction image, advice animal, exploitable, copypasta, etc.]
- **Template/Format:** [If it's based on a known meme template, name it]
- **Good For:** [List 3-5 contexts, situations, or topics where this meme would be relevant/useful. Be specific about the emotions, ideas, or situations it expresses. This helps others find this meme when writing about similar topics.]

Examples of "Good For":
- Illustrating procrastination or delayed tasks
- Expressing excitement about new technology
- Showing confusion about complex topics
- Representing productivity struggles
- Conveying skepticism about claims

If no, explain what type of media it is instead (photo, infographic, screenshot, chart, etc.)
{% endif %}
```

Output ONLY the markdown. No preamble. No code fences. Raw markdown that can be saved directly to a .md file.

{% elif mode == "media_batch" %}
You are analyzing {{ image_count }} images in a single batch. For EACH image, provide:

1. A short descriptive slug (lowercase, hyphens only, e.g., "sunset-beach-scene")
2. A 2-3 sentence description of the image content
3. Alt text for accessibility

{% if pii_prevention and pii_prevention.enabled %}
⚠️ **CRITICAL: PII Check** - If any image contains identifiable faces, license plates, IDs, or personal documents:
- Use generic descriptions (e.g., "a person" instead of describing facial features)
- Do NOT include readable text containing personal information
{% endif %}

## Images to Process
The following {{ image_count }} images are attached to this request (in order):
{{ filenames_json }}

## Output Format
Return ONLY a valid JSON object where keys are the **exact original filenames** and values contain:
- `slug`: short descriptive slug (lowercase, hyphens)
- `description`: 2-3 sentence description
- `alt_text`: accessibility description

Example format:
```json
{
  "IMG-20250101.jpg": {"slug": "sunset-beach-view", "description": "A beautiful sunset over a sandy beach with waves.", "alt_text": "Orange sunset over ocean beach with gentle waves"},
  "photo_002.png": {"slug": "coffee-cup-desk", "description": "A steaming cup of coffee on a wooden desk.", "alt_text": "White coffee mug on brown wooden desk"}
}
```

**IMPORTANT**: Output ONLY the JSON object. No markdown code fences, no explanatory text - just raw JSON.

{% elif mode == "url_batch" %}
You are analyzing {{ url_count }} URLs in a single batch. For EACH URL, provide:

1. A short descriptive slug (lowercase, hyphens only, e.g., "alignment-forum-mesa-optimizers")
2. A 2-3 sentence summary of the URL content
3. Key takeaways (3-5 bullet points as a list)

{% if pii_prevention and pii_prevention.enabled %}
⚠️ **Privacy Notice** - Do not include any personally identifiable information from the URLs.
{% endif %}

## URLs to Process
The following {{ url_count }} URLs need enrichment:
{{ urls_json }}

## Output Format
Return ONLY a valid JSON object where keys are the **exact original URLs** and values contain:
- `slug`: short descriptive slug (lowercase, hyphens)
- `summary`: 2-3 sentence description of the content
- `key_takeaways`: list of 3-5 key points

Example format:
```json
{
  "https://example.com/article": {
    "slug": "example-article-topic",
    "summary": "This article discusses...",
    "key_takeaways": ["Point 1", "Point 2", "Point 3"]
  }
}
```

**IMPORTANT**: Output ONLY the JSON object. No markdown code fences, no explanatory text - just raw JSON.
{% endif %}
