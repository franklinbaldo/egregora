{% macro render_tags(tags, index_url) -%}
    <div class="blogging-tags-grid">
        {% for tag in tags %}
        <a href="{{ index_url }}#{{ tag }}" class="blogging-tag"><code>#{{ tag }}</code></a>
        {% endfor %}
    </div>
    {{ caller() }}
{% endmacro %}

{% macro get_tags_style() -%}
<style>
    .md-typeset .blogging-tags-grid {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
    }

    .md-typeset .blogging-tag {
        color: var(--md-typeset-color);
        background-color: var(--md-typeset-code-color);
        white-space: nowrap;
        display: block;
    }

    .md-typeset .blogging-tag code {
        border-radius: 5px;
    }
</style>
{{ caller() }}
{% endmacro %}

{% block style %}
<style>
  .md-typeset .blog-grid {
    display: grid;
    gap: 1.5rem;
  }
  @media (min-width: 960px) {
    .md-typeset .blog-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  .md-typeset .blog-card {
    border: 1px solid var(--md-default-fg-color--lightest);
    border-radius: .6rem;
    padding: 1.25rem;
    background: var(--md-default-bg-color);
    box-shadow: 0 .35rem 1rem rgba(0,0,0,.04);
    display: flex;
    flex-direction: column;
    gap: .75rem;
  }
  .md-typeset .blog-card h3 {
    margin: 0;
    font-size: 1.1rem;
  }
  .md-typeset .blog-card time {
    font-size: .85rem;
    color: var(--md-default-fg-color--light);
  }
  .md-typeset .blog-card__meta {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    font-size: .8rem;
    color: var(--md-default-fg-color--light);
  }
  .md-typeset .blog-card__summary {
    line-height: 1.45;
  }
  .md-typeset .blog-card__contributors code {
    background: rgb(99 102 241 / 12%);
    color: var(--md-accent-fg-color);
  }
</style>
{% call get_tags_style() %}{% endcall %}
{% endblock %}

{% set page_num = (pages|count / page_size)|round(method='ceil')|int %}

{% if page_num == 0 or not paging %}
    {% set page_num = 1 %}
    {% if not paging %}
        {% set page_size = (10000 if page_size == -1 else page_size) %}
    {% endif %}
{% endif %}

{%- macro contributor_label(authors) -%}
    {%- set display = [] -%}
    {%- for author in authors -%}
        {%- set anon = author[:8] if author else loop.index -%}
        {%- set _ = display.append("Anon " ~ anon) -%}
    {%- endfor -%}
    {{ display|join(", ") }}
{%- endmacro -%}

<div class="md-typeset">
  {% for page_idx in range(0, page_num) %}
  {% set pg_group = pages[page_idx*page_size:(page_idx + 1)*page_size] %}
  <div class="blog-grid" id="page{{ page_idx + 1 }}">
    {% for pg in pg_group %}
      {% set url = pg.canonical_url %}
      {% set title = pg.title %}
      {% if pg.meta and pg.meta.title_full %}
          {% set title = pg.meta.title_full %}
      {% endif %}
      {% set summary = pg.meta.summary or pg.meta.description or "" %}
      {% if full_content and not summary %}
          {% set summary = pg.content|safe %}
      {% endif %}
      {% set time = pg.meta["localized-time"] if pg.meta and pg.meta["localized-time"] else "" %}
      {% set tags = pg.meta["tags"] if pg.meta and "tags" in pg.meta else [] %}
      {% set authors = pg.meta["authors"] if pg.meta and "authors" in pg.meta else [] %}
      <article class="blog-card"
               data-blog-card
               data-tags="{{ tags|join(',') }}"
               data-authors="{{ authors|join(',') }}"
               data-date="{{ (pg.meta['date'] if pg.meta and 'date' in pg.meta else '') }}"
               data-title="{{ title|lower }}">
        <div>
          {% if time %}
          <time datetime="{{ time }}">{{ time }}</time>
          {% endif %}
          <h3><a href="{{ url }}">{{ title }}</a></h3>
        </div>
        {% if summary %}
        <p class="blog-card__summary">{{ summary }}</p>
        {% endif %}
        <div class="blog-card__meta">
          {% if authors %}
          <span class="blog-card__contributors">
            ðŸ‘¤ <code>{{ contributor_label(authors) }}</code>
          </span>
          {% endif %}
          {% if tags %}
            {% call render_tags(tags, index_url) %}
            {% endcall %}
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>
  {% endfor %}

  {% if page_num > 1 %}
    <div class="blog-center">
      <div class="blog-pagination" id="blog-pagination">
        {% for num in range(page_num) %}
          {% if num == 0 %}
            {% set link = "" %}
          {% else %}
            {% set link = "#blog-p" + (num + 1)|string %}
          {% endif %}
          <a class="page-number" href="{{ link }}">{{ num + 1 }}</a>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>
